<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد فروش - منطق دقیق سررسید</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --primary: #1e293b;
            --text-main: #334155;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-color); color: var(--text-main); }
        .card { background-color: var(--card-bg); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 1.5rem; border: 1px solid #e2e8f0; }
        
        .table-wrapper {
            overflow-y: auto;
            height: 500px;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            position: relative;
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th {
            position: sticky; top: 0;
            background-color: var(--primary);
            color: white;
            z-index: 20;
            padding: 1rem;
            text-align: right;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.875rem;
            background-color: white;
        }
        tfoot th, tfoot td {
            position: sticky; bottom: 0;
            background-color: #0f172a;
            color: white;
            z-index: 20;
            font-weight: bold;
            padding: 1rem;
            border-top: 2px solid #cbd5e1;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-8xl mx-auto space-y-10">
        
        <!-- Header -->
        <div class="card border-r-4 border-slate-800 flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">داشبورد جامع فروش و مطالبات</h1>
                <p class="text-slate-500 mt-2 font-bold text-sm">
                    تاریخ مبنا: <span class="text-blue-600 font-bold bg-blue-50 px-2 rounded">۱۶ دی ۱۴۰۴</span> |
                    شرط وصول: <span class="text-red-600 bg-red-50 px-2 rounded font-bold">پایان ماه سررسید</span>
                </p>
            </div>
            
            <div class="flex flex-col items-end gap-3 w-full md:w-auto">
                <div class="relative group w-full md:w-auto">
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden" />
                    <label for="csvFileInput" class="cursor-pointer bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition-all w-full md:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span>بارگذاری CSV</span>
                    </label>
                </div>
                
                <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                    <div class="w-full md:w-48">
                        <select id="yearSelect" class="w-full bg-slate-100 border-2 border-slate-200 rounded-xl p-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                            <option value="all">همه سال‌ها</option>
                            <option value="1403">سال ۱۴۰۳</option>
                            <option value="1404">سال ۱۴۰۴</option>
                        </select>
                    </div>
                    <div class="w-full md:w-72">
                        <select id="employerSelect" class="w-full bg-slate-100 border-2 border-slate-200 rounded-xl p-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                            <option value="all">همه مشتریان (کل پورتفو)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div class="card border-t-4 border-gray-400">
                <p class="text-xs font-bold text-gray-500 mb-1">فروش کل ۱۴۰۳</p>
                <p class="text-xl font-black text-gray-700 dir-ltr" id="kpi1403">0</p>
                <p class="text-xs text-gray-400 mt-1">میلیارد ریال</p>
            </div>
            <div class="card border-t-4 border-red-500">
                <p class="text-xs font-bold text-red-500 mb-1">فروش ۱۴۰۴ (تاکنون)</p>
                <p class="text-xl font-black text-red-700 dir-ltr" id="kpi1404">0</p>
                <p class="text-xs text-red-400 mt-1">میلیارد ریال</p>
            </div>
            <div class="card border-t-4 border-emerald-500">
                <p class="text-xs font-bold text-emerald-600 mb-1">تعداد کل ست‌ها</p>
                <p class="text-xl font-black text-emerald-800 dir-ltr" id="kpiCount">0</p>
                <p class="text-xs text-emerald-500 mt-1">ست / قطعه</p>
            </div>
            <div class="card border-t-4 border-indigo-600 bg-indigo-50">
                <p class="text-xs font-bold text-indigo-800 mb-1">مطالبات نقد شده (واقعی)</p>
                <p class="text-xl font-black text-indigo-900 dir-ltr" id="kpiDueTotal">0</p>
                <p class="text-xs text-indigo-600 mt-1">سررسید گذشته (پاس شده)</p>
            </div>
            <div class="card border-t-4 border-amber-500">
                <p class="text-xs font-bold text-amber-600 mb-1">مجموع سهم شرکت</p>
                <p class="text-xl font-black text-amber-800 dir-ltr" id="kpiShare">0</p>
                <div class="text-xs mt-1 font-bold flex items-center gap-1 text-slate-600 bg-amber-50 px-2 py-1 rounded w-fit">
                    <span>(نقد شده: </span>
                    <span class="dir-ltr font-mono" id="kpiShareDue">0</span>
                    <span>)</span>
                </div>
            </div>
        </div>

        <!-- SECTION 1: Total Amount -->
        <div>
            <h2 class="section-title"><span class="w-2 h-8 bg-slate-800 rounded mr-2"></span>۱. تحلیل جامع مبلغ کل فروش (میلیارد ریال)</h2>
            <div class="card h-[500px]">
                <canvas id="chartAmountCombo"></canvas>
            </div>
        </div>

        <!-- SECTION 2: Count -->
        <div>
            <h2 class="section-title"><span class="w-2 h-8 bg-emerald-600 rounded mr-2"></span>۲. تحلیل جامع تعداد فروش (ست)</h2>
            <div class="card h-[500px]">
                <canvas id="chartCountCombo"></canvas>
            </div>
        </div>

        <!-- SECTION 3: Share Amount -->
        <div>
            <h2 class="section-title"><span class="w-2 h-8 bg-amber-500 rounded mr-2"></span>۳. تحلیل جامع مبلغ سهم (میلیارد ریال)</h2>
            <div class="card h-[500px]">
                <canvas id="chartShareCombo"></canvas>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-slate-800 text-lg">ریز داده‌های فروش و وضعیت وصول</h3>
                <div class="flex gap-2 items-center flex-wrap">
                    <span class="text-xs bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full border border-indigo-100 font-bold">زامیاد: پایان ماه ۳ (وصول در ماه ۴)</span>
                    <span class="text-xs bg-slate-100 text-slate-700 px-3 py-1 rounded-full border border-slate-200 font-bold">سایرین: پایان ماه ۴ (وصول در ماه ۵)</span>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('year')" style="width: 10%">سال ↕</th>
                            <th onclick="sortTable('month')" style="width: 10%">ماه ↕</th>
                            <th onclick="sortTable('source')" style="width: 20%">مشتری ↕</th>
                            <th onclick="sortTable('count')" style="width: 10%">تعداد (ست) ↕</th>
                            <th onclick="sortTable('amount')" style="width: 15%">مبلغ کل ↕</th>
                            <th onclick="sortTable('share')" style="width: 15%">مبلغ سهم ↕</th>
                            <th class="bg-indigo-900 text-indigo-100 border-r border-indigo-700" onclick="sortTable('receivable')" style="width: 20%">وضعیت وصول ↕</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-center">جمع کل (فیلتر شده)</td>
                            <td class="dir-ltr text-emerald-400 font-mono" id="sumCount">0</td>
                            <td class="dir-ltr text-blue-400 font-mono" id="sumAmount">0</td>
                            <td class="dir-ltr text-amber-400 font-mono" id="sumShare">0</td>
                            <td class="dir-ltr text-indigo-300 bg-indigo-950 border-r border-indigo-800 font-mono" id="sumDue">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        Chart.defaults.font.family = 'Vazirmatn';
        Chart.defaults.color = '#64748b';
        
        const STYLES = {
            bar1403: '#cbd5e1',       // Gray (1403 Bar)
            bar1404: '#f87171',       // Red (1404 Bar)
            line1403: '#3b82f6',      // Blue Dashed (1403 Cumulative)
            line1404: '#b91c1c'       // Red Solid (1404 Cumulative)
        };

        const monthsList = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
        
        // --- FIXED DATE LOGIC (TODAY IS 16 DEY 1404) ---
        const REPORT_YEAR = 1404;
        const REPORT_MONTH_IDX = 9; // Dey is Index 9 (0-based)

        let globalData = [];
        let currentFilteredData = [];
        let chartInstances = {};

        // Default Data
        const initialCSVData = `ردیف,سال,ماه,کارفرما,تعداد (ست),"مبلغ کل (میلیون ریال)","مبلغ سهم (میلیون ریال)"
1,1403,فروردین,سازه گستر,"11,987","773,264","497,242"
2,1403,اردیبهشت,سازه گستر,"54,328","1,978,107","2,305,251"
13,1403,فروردین,زامیاد,0,0,0
14,1403,اردیبهشت,زامیاد,50,"2,508","2,508"`;

        // --- DATA PARSING & LOGIC ---
        function parseCSVLine(text) {
            const result = [];
            let cur = '';
            let inQuote = false;
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (c === '"') { inQuote = !inQuote; } 
                else if (c === ',' && !inQuote) { result.push(cur.trim()); cur = ''; } 
                else { cur += c; }
            }
            result.push(cur.trim());
            return result;
        }

        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');
            let start = lines[0].includes('کارفرما') ? 1 : 0;

            for(let i=start; i<lines.length; i++){
                let line = lines[i].trim();
                if(!line) continue;
                
                const parts = parseCSVLine(line);
                if(parts.length < 6) continue;

                let id = parts[0].trim();
                let year = parseInt(parts[1].trim());
                let month = parts[2].trim().replace('ابان', 'آبان');
                let source = parts[3].trim();
                
                let count = parseFloat((parts[4] || "0").replace(/["',]/g, '')) || 0;
                let amountBillion = (parseFloat((parts[5] || "0").replace(/["',]/g, '')) || 0) / 1000;
                let shareBillion = (parseFloat((parts[6] || "0").replace(/["',]/g, '')) || 0) / 1000;

                // --- STRICT 90/120 DAY LOGIC ---
                let mIndex = monthsList.indexOf(month); 
                let shareDue = 0;
                let receivableAmount = 0;
                let dueText = "---";

                if (mIndex !== -1) {
                    let saleAbsMonth = (year * 12) + mIndex;
                    
                    // Logic:
                    // Zamyad: Sale Month + 3 (Due End of M+3). So Realized in M+4.
                    // Others: Sale Month + 4 (Due End of M+4). So Realized in M+5.
                    let addMonths = source.includes("زامیاد") ? 3 : 4;
                    
                    // The month INDEX of the due date (End of this month it matures)
                    let dueAbsMonth = saleAbsMonth + addMonths;
                    let currentAbsMonth = (REPORT_YEAR * 12) + REPORT_MONTH_IDX;

                    // STRICT CONDITION: Current Month must be GREATER than Due Month to be fully realized cash
                    // OR if we consider "End of Month" as the check date, and today is 16th, it's not cashed yet.
                    if (currentAbsMonth > dueAbsMonth) {
                        shareDue = shareBillion; 
                        receivableAmount = amountBillion;
                        dueText = "نقد شده";
                    } else {
                        // Not yet realized
                        let dYear = Math.floor(dueAbsMonth / 12);
                        let dMonthIdx = dueAbsMonth % 12;
                        dueText = `سررسید: انتهای ${monthsList[dMonthIdx]} ${dYear}`;
                    }
                }

                rows.push({
                    id, year, month, source, count,
                    amount: amountBillion,
                    share: shareBillion,
                    shareDue: shareDue,
                    receivable: receivableAmount,
                    dueText: dueText
                });
            }
            return rows;
        }

        // --- INIT ---
        function init(csv) {
            globalData = parseCSV(csv);
            
            const employers = [...new Set(globalData.map(d => d.source))].sort();
            const select = document.getElementById('employerSelect');
            select.innerHTML = '<option value="all">همه مشتریان (کل پورتفو)</option>';
            employers.forEach(emp => {
                const opt = document.createElement('option');
                opt.value = emp; opt.textContent = emp; select.appendChild(opt);
            });

            document.getElementById('employerSelect').addEventListener('change', applyFilters);
            document.getElementById('yearSelect').addEventListener('change', applyFilters);

            applyFilters();
        }

        function applyFilters() {
            const empVal = document.getElementById('employerSelect').value;
            const yearVal = document.getElementById('yearSelect').value;

            // Filter for KPI & Table
            const filteredForKPI = globalData.filter(d => {
                const empMatch = empVal === 'all' || d.source === empVal;
                const yearMatch = yearVal === 'all' || d.year.toString() === yearVal;
                return empMatch && yearMatch;
            });

            updateKPIs(filteredForKPI);
            renderTable(filteredForKPI);
            
            // Charts (Year Independent)
            updateAllCharts(empVal); 
        }

        function updateKPIs(data) {
            const t1403 = data.filter(d => d.year === 1403).reduce((s,d) => s + d.amount, 0);
            const t1404 = data.filter(d => d.year === 1404).reduce((s,d) => s + d.amount, 0);
            const count = data.reduce((s,d) => s + d.count, 0);
            const share = data.reduce((s,d) => s + d.share, 0);
            const shareDue = data.reduce((s,d) => s + d.shareDue, 0);
            const totalDue = data.reduce((s,d) => s + d.receivable, 0);
            
            document.getElementById('kpi1403').innerText = t1403.toLocaleString(undefined, {maximumFractionDigits: 1});
            document.getElementById('kpi1404').innerText = t1404.toLocaleString(undefined, {maximumFractionDigits: 1});
            document.getElementById('kpiCount').innerText = count.toLocaleString();
            document.getElementById('kpiDueTotal').innerText = totalDue.toLocaleString(undefined, {maximumFractionDigits: 1});
            document.getElementById('kpiShare').innerText = share.toLocaleString(undefined, {maximumFractionDigits: 1});
            document.getElementById('kpiShareDue').innerText = shareDue.toLocaleString(undefined, {maximumFractionDigits: 1});
        }

        // --- CHARTS ---
        function generateChartSet(client, metricKey, chartId) {
            let data = globalData;
            if(client !== 'all') data = globalData.filter(d => d.source === client);

            const m1403 = [], m1404 = [], c1403 = [], c1404 = [];
            let acc1403 = 0, acc1404 = 0;

            monthsList.forEach((m, idx) => {
                const v1403 = data.filter(d => d.year === 1403 && d.month.includes(m.substring(0,3))).reduce((s,d)=>s+d[metricKey],0);
                const v1404 = data.filter(d => d.year === 1404 && d.month.includes(m.substring(0,3))).reduce((s,d)=>s+d[metricKey],0);
                
                m1403.push(v1403);
                acc1403 += v1403;
                c1403.push(acc1403);

                if(idx > 7) { // Cutoff for 1404 visuals
                    m1404.push(null); c1404.push(null);
                } else {
                    m1404.push(v1404); acc1404 += v1404; c1404.push(acc1404);
                }
            });

            const ctx = document.getElementById(chartId).getContext('2d');
            if(chartInstances[chartId]) chartInstances[chartId].destroy();
            
            chartInstances[chartId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthsList,
                    datasets: [
                        { type: 'bar', label: 'ماهانه ۱۴۰۳', data: m1403, backgroundColor: STYLES.bar1403, order: 3, yAxisID: 'yLeft' },
                        { type: 'bar', label: 'ماهانه ۱۴۰۴', data: m1404, backgroundColor: STYLES.bar1404, order: 4, yAxisID: 'yLeft' },
                        { type: 'line', label: 'تجمعی ۱۴۰۳', data: c1403, borderColor: STYLES.line1403, borderDash: [5, 5], borderWidth: 2, pointRadius: 3, fill: false, order: 2, yAxisID: 'yRight' },
                        { type: 'line', label: 'تجمعی ۱۴۰۴', data: c1404, borderColor: STYLES.line1404, borderWidth: 3, pointRadius: 4, fill: false, order: 1, yAxisID: 'yRight' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top', labels: { font: { family: 'Vazirmatn' } } } },
                    scales: {
                        yLeft: { type: 'linear', display: true, position: 'left', grid: { display: false } },
                        yRight: { type: 'linear', display: true, position: 'right', grid: { borderDash: [2, 2] } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateAllCharts(client) {
            generateChartSet(client, 'amount', 'chartAmountCombo');
            generateChartSet(client, 'count', 'chartCountCombo');
            generateChartSet(client, 'share', 'chartShareCombo');
        }

        // --- TABLE ---
        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            let sCount = 0, sAmount = 0, sShare = 0, sRec = 0;

            data.forEach(d => {
                sCount += d.count; sAmount += d.amount; sShare += d.share; sRec += d.receivable;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition';
                const yrClass = d.year === 1404 ? 'text-red-600 bg-red-50' : 'text-gray-500 bg-gray-50';
                
                let recClass = "text-slate-400 italic"; 
                let recVal = d.dueText;
                
                if (d.receivable > 0) {
                    recClass = "text-indigo-700 font-bold bg-indigo-50";
                    recVal = d.amount.toLocaleString(undefined, {maximumFractionDigits: 3});
                }

                tr.innerHTML = `
                    <td class="font-bold text-center"><span class="px-2 py-1 rounded ${yrClass}">${d.year}</span></td>
                    <td class="text-slate-700">${d.month}</td>
                    <td class="font-bold text-slate-800 text-right">${d.source}</td>
                    <td class="font-mono dir-ltr text-emerald-600">${d.count.toLocaleString()}</td>
                    <td class="font-mono dir-ltr font-bold text-blue-700">${d.amount.toLocaleString(undefined, {maximumFractionDigits: 3})}</td>
                    <td class="font-mono dir-ltr text-amber-600 text-sm">${d.share.toLocaleString(undefined, {maximumFractionDigits: 3})}</td>
                    <td class="font-mono dir-ltr ${recClass} border-r border-slate-100 text-sm">${recVal}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('sumCount').innerText = sCount.toLocaleString();
            document.getElementById('sumAmount').innerText = sAmount.toLocaleString(undefined, {maximumFractionDigits: 3});
            document.getElementById('sumShare').innerText = sShare.toLocaleString(undefined, {maximumFractionDigits: 3});
            document.getElementById('sumDue').innerText = sRec.toLocaleString(undefined, {maximumFractionDigits: 3});
        }

        // Sorting
        let sortDir = 1;
        window.sortTable = function(key) {
            sortDir *= -1;
            let dataToSort = currentFilteredData.length > 0 ? currentFilteredData : globalData;
            dataToSort.sort((a,b) => {
                let vA = a[key], vB = b[key];
                if(typeof vA === 'string') return sortDir * vA.localeCompare(vB);
                return sortDir * (vA - vB);
            });
            renderTable(dataToSort);
        }

        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { init(e.target.result); alert('فایل جدید بارگذاری شد.'); };
            reader.readAsText(file);
        });

        init(initialCSVData);
    </script>
</body>
</html>
