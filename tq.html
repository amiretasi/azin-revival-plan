<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد جامع مدیریت کمیسیون معاملات</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- فونت وزیرمتن -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- آیکون‌ها -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f8fafc; color: #334155; }
        .header-bg { background: linear-gradient(to left, #0f172a, #334155); color: white; padding: 2rem 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); transition: 0.3s; }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .card-title { font-size: 1.1rem; font-weight: 800; color: #1e293b; margin-bottom: 1.25rem; padding-bottom: 0.75rem; border-bottom: 2px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .drop-zone { border: 3px dashed #cbd5e1; background: #f1f5f9; transition: all 0.3s; }
        .drop-zone.active { border-color: #3b82f6; background: #eff6ff; transform: scale(1.005); }
        
        .year-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: left 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-left: 2.5rem;
            padding-right: 1rem;
        }
    </style>
</head>
<body>

    <!-- هدر -->
    <div class="header-bg text-center mb-8">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl md:text-4xl font-extrabold mb-2 tracking-tight">داشبورد جامع کمیسیون معاملات</h1>
            <p class="text-slate-300 text-lg font-light">تحلیل استراتژیک مصوبات، وضعیت حقوقی و سطوح معاملات</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-12">

        <!-- آپلود فایل -->
        <div id="upload-section" class="max-w-3xl mx-auto mb-12 text-center">
            <div id="drop-zone" class="drop-zone rounded-2xl p-12 cursor-pointer relative group shadow-sm border-slate-300">
                <input type="file" id="fileInput" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div class="space-y-4 pointer-events-none">
                    <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto group-hover:bg-blue-200 transition">
                        <i class="fas fa-file-csv text-4xl text-blue-600"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-slate-700">بارگذاری فایل CSV (نسخه جدید)</h3>
                        <p class="text-slate-500 mt-2">فایل خروجی سیستم را اینجا رها کنید</p>
                    </div>
                </div>
            </div>
            <div id="error-msg" class="hidden mt-6 p-4 bg-red-50 text-red-700 rounded-xl border border-red-200 text-sm font-bold"></div>
        </div>

        <!-- محتوای داشبورد -->
        <div id="dashboard" class="hidden opacity-0 transition-opacity duration-700">
            
            <!-- نوار ابزار: فیلتر سال -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <div class="flex items-center gap-3 mb-4 md:mb-0">
                    <div class="bg-indigo-100 p-2 rounded-lg"><i class="fas fa-calendar-alt text-indigo-600"></i></div>
                    <span class="font-bold text-slate-700">فیلتر زمانی:</span>
                </div>
                <div class="flex items-center gap-4">
                    <select id="yearFilter" class="year-select bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-48 p-2.5 font-bold shadow-sm">
                        <option value="all">نمایش کل ادوار</option>
                    </select>
                    <button onclick="location.reload()" class="text-slate-400 hover:text-red-500 transition p-2" title="بارگذاری مجدد">
                        <i class="fas fa-sync-alt fa-lg"></i>
                    </button>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card border-r-4 border-blue-600">
                    <p class="text-slate-500 text-sm mb-1 font-medium">جمع کل مصوبات (هزینه‌ای)</p>
                    <div class="text-2xl font-extrabold text-blue-800" id="kpi-total">0</div>
                    <span class="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded mt-2 inline-block font-bold">میلیارد ریال</span>
                </div>
                <div class="card border-r-4 border-emerald-600">
                    <p class="text-slate-500 text-sm mb-1 font-medium">درآمد حاصله (فروش)</p>
                    <div class="text-2xl font-extrabold text-emerald-700" id="kpi-income">0</div>
                    <span class="text-xs bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded mt-2 inline-block font-bold">میلیارد ریال</span>
                </div>
                <div class="card border-r-4 border-amber-500">
                    <p class="text-slate-500 text-sm mb-1 font-medium">شاخص ریسک (ترک تشریفات)</p>
                    <div class="text-2xl font-extrabold text-amber-700" id="kpi-risk">0%</div>
                    <span class="text-xs bg-amber-50 text-amber-600 px-2 py-0.5 rounded mt-2 inline-block font-bold">از حجم ریالی</span>
                </div>
                <div class="card border-r-4 border-slate-500">
                    <p class="text-slate-500 text-sm mb-1 font-medium">تعداد کل پرونده‌ها</p>
                    <div class="text-2xl font-extrabold text-slate-800" id="kpi-count">0</div>
                    <span class="text-xs bg-slate-100 text-slate-600 px-2 py-0.5 rounded mt-2 inline-block font-bold">فقره</span>
                </div>
            </div>

            <!-- Row 1: Status & Level (New Charts) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="card relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                    <h3 class="card-title">
                        <span>وضعیت تصویب (هیئت مدیره)</span>
                        <i class="fas fa-gavel text-purple-200 text-2xl"></i>
                    </h3>
                    <div class="h-72"><canvas id="chartStatus"></canvas></div>
                </div>
                <div class="card relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-orange-500"></div>
                    <h3 class="card-title">
                        <span>سطح معاملات (نصاب)</span>
                        <i class="fas fa-layer-group text-orange-200 text-2xl"></i>
                    </h3>
                    <div class="h-72"><canvas id="chartLevel"></canvas></div>
                </div>
            </div>

            <!-- Row 2: Method & Timeline -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="card">
                    <h3 class="card-title"><span>ترکیب روش‌های واگذاری</span><i class="fas fa-chart-pie text-slate-300"></i></h3>
                    <div class="h-72"><canvas id="chartMethod"></canvas></div>
                </div>
                <div class="card">
                    <h3 class="card-title"><span>روند زمانی هزینه (ماهانه)</span><i class="fas fa-chart-line text-slate-300"></i></h3>
                    <div class="h-72"><canvas id="chartTimeline"></canvas></div>
                </div>
            </div>

            <!-- Row 3: Category & Vendors -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="card lg:col-span-2">
                    <h3 class="card-title"><span>تفکیک موضوعی هوشمند</span><i class="fas fa-cubes text-slate-300"></i></h3>
                    <div class="h-80"><canvas id="chartCategory"></canvas></div>
                </div>
                <div class="card">
                    <h3 class="card-title"><span>پیمانکاران برتر</span><i class="fas fa-building text-slate-300"></i></h3>
                    <div class="h-80"><canvas id="chartVendors"></canvas></div>
                </div>
            </div>

            <!-- Analysis Section -->
            <div id="management-alerts" class="mt-12 space-y-6">
                <h3 class="text-xl font-bold text-slate-800 border-r-4 border-blue-600 pr-4">تحلیل‌های مدیریتی و هشدارها</h3>
                <div id="risk-alerts-content" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
        </div>
    </div>

    <script>
        // --- تنظیمات Chart.js ---
        try {
            Chart.defaults.font.family = '"Vazirmatn", sans-serif';
            Chart.defaults.color = '#64748b';
            Chart.defaults.plugins.tooltip.titleFont.family = '"Vazirmatn", sans-serif';
            Chart.defaults.plugins.tooltip.bodyFont.family = '"Vazirmatn", sans-serif';
            Chart.defaults.plugins.legend.labels.font.family = '"Vazirmatn", sans-serif';
        } catch(e) { console.warn("Font loading issue", e); }

        // --- توابع فرمت‌دهی ---
        const formatWithCommas = (num) => {
            if (num === null || num === undefined) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        };

        const formatAxis = (num) => {
            return formatWithCommas((num / 1e9).toFixed(0)) + ' B';
        };

        // --- متغیرهای سراسری ---
        let GLOBAL_DATA = [];
        let charts = {};

        // --- هندلینگ فایل ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');

        ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, (evt) => { evt.preventDefault(); dropZone.classList.add('active'); }));
        ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, (evt) => { evt.preventDefault(); dropZone.classList.remove('active'); }));
        dropZone.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]));
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            if(!file) return;
            document.getElementById('error-msg').classList.add('hidden');
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: (results) => processData(results.data),
                error: (err) => showError("خطا: " + err.message)
            });
        }

        function cleanNum(val) {
            if(!val) return 0;
            if(typeof val === 'number') return val;
            let cleaned = val.replace(/,/g, '').replace(/[^\d.-]/g, '');
            return parseFloat(cleaned) || 0;
        }

        function categorize(subject) {
            if(!subject) return 'سایر';
            const s = subject.toLowerCase();
            if(s.includes('فوم') || s.includes('ایزوسیانات')) return 'مواد اولیه (فوم)';
            if(s.includes('پارچه') || s.includes('روکش') || s.includes('چرم')) return 'منسوجات و روکش';
            if(s.includes('فلزی') || s.includes('فریم') || s.includes('لوله')) return 'قطعات فلزی/مکانیزم';
            if(s.includes('پلیمری') || s.includes('پلاستیک')) return 'قطعات پلیمری';
            if(s.includes('الکترونیک') || s.includes('برق') || s.includes('سنسور')) return 'برق و الکترونیک';
            if(s.includes('حمل')) return 'لجستیک و حمل';
            if(s.includes('غذا') || s.includes('رفاهی')) return 'خدمات رفاهی';
            if(s.includes('قالب') || s.includes('ابزار')) return 'قالب و ابزار';
            if(s.includes('زمین') || s.includes('فروش') || s.includes('ضایعات')) return 'فروش دارایی/ضایعات';
            return 'سایر';
        }

        function processData(data) {
            try {
                GLOBAL_DATA = data.map((row, idx) => {
                    const keys = Object.keys(row);
                    const amountKey = keys.find(k => k.includes('مبلغ') && (k.includes('ریال') || k.includes('(ریال)')));
                    const vendorKey = keys.find(k => k.includes('پیمانکار') || k.includes('برنده'));
                    const subjectKey = keys.find(k => k.includes('موضوع'));
                    const dateKey = keys.find(k => k.includes('تاریخ'));
                    const typeKey = keys.find(k => k.includes('نحوه تصویب') || k.includes('تشریفات'));
                    const buySellKey = keys.find(k => k.includes('خرید') && k.includes('فروش'));
                    
                    // New Columns
                    const statusKey = keys.find(k => k.includes('وضعیت'));
                    const levelKey = keys.find(k => k.includes('نصاب') || k.includes('سطح'));

                    if (!amountKey) return null;

                    const amount = cleanNum(row[amountKey]);
                    const dateStr = row[dateKey] || '';
                    const year = dateStr.length >= 4 ? dateStr.substring(0, 4) : 'نامشخص';
                    const isIncome = (row[buySellKey] || '').includes('فروش') || (row[subjectKey] || '').includes('فروش');
                    let vendor = (row[vendorKey] || 'نامشخص').split('-')[0].split('،')[0].split('(')[0].trim();

                    return {
                        id: idx,
                        amount: amount,
                        vendor: vendor,
                        subject: row[subjectKey] || '',
                        date: dateStr,
                        year: year,
                        type: (row[typeKey] || '').includes('ترک') ? 'ترک تشریفات' : (row[typeKey] || '').includes('تک') ? 'تک منبع' : 'عادی',
                        isIncome: isIncome,
                        category: categorize(row[subjectKey] || ''),
                        status: row[statusKey] || 'نامشخص',
                        level: row[levelKey] || 'نامشخص'
                    };
                }).filter(d => d !== null && d.amount > 0);

                if(GLOBAL_DATA.length === 0) throw new Error("داده معتبری یافت نشد. لطفاً فایل CSV صحیح را بارگذاری کنید.");

                initYearFilter();
                updateDashboard();
                
                document.getElementById('upload-section').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                setTimeout(() => document.getElementById('dashboard').classList.remove('opacity-0'), 50);

            } catch(e) { showError(e.message); }
        }

        function initYearFilter() {
            const years = [...new Set(GLOBAL_DATA.map(d => d.year).filter(y => y !== 'نامشخص'))].sort();
            const select = document.getElementById('yearFilter');
            while(select.options.length > 1) { select.remove(1); }
            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.innerText = `سال ${y}`;
                select.appendChild(opt);
            });
            select.addEventListener('change', updateDashboard);
        }

        function updateDashboard() {
            const selectedYear = document.getElementById('yearFilter').value;
            const filteredData = selectedYear === 'all' ? GLOBAL_DATA : GLOBAL_DATA.filter(d => d.year === selectedYear);

            const expenses = filteredData.filter(d => !d.isIncome);
            const income = filteredData.filter(d => d.isIncome);
            
            const totalExp = expenses.reduce((a,b) => a + b.amount, 0);
            const totalInc = income.reduce((a,b) => a + b.amount, 0);
            const turkExp = expenses.filter(d => d.type === 'ترک تشریفات').reduce((a,b) => a + b.amount, 0);
            const riskRatio = totalExp > 0 ? Math.round((turkExp/totalExp)*100) : 0;

            document.getElementById('kpi-total').innerText = formatWithCommas((totalExp/1e9).toFixed(1));
            document.getElementById('kpi-income').innerText = formatWithCommas((totalInc/1e9).toFixed(1));
            document.getElementById('kpi-risk').innerText = riskRatio + '%';
            document.getElementById('kpi-count').innerText = formatWithCommas(filteredData.length);

            // Render existing charts
            renderChart('chartMethod', 'doughnut', expenses, 'type');
            renderTimelineChart('chartTimeline', expenses);
            renderChart('chartCategory', 'bar', expenses, 'category');
            renderHorizontalChart('chartVendors', expenses, 'vendor');
            
            // Render NEW charts
            renderChart('chartStatus', 'pie', expenses, 'status', true);
            renderChart('chartLevel', 'bar', expenses, 'level');

            renderAnalysis(expenses, totalExp, riskRatio);
        }

        // --- Render Functions ---

        function renderChart(id, type, data, key, isPie = false) {
            const counts = {};
            data.forEach(d => counts[d[key]] = (counts[d[key]]||0) + d.amount);
            const labels = Object.keys(counts);
            const values = Object.values(counts);

            const bgColors = [
                '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#f97316', '#64748b', '#06b6d4'
            ];

            if(charts[id]) charts[id].destroy();

            charts[id] = new Chart(document.getElementById(id), {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'مبلغ (ریال)',
                        data: values,
                        backgroundColor: (type === 'bar' && !isPie) ? '#6366f1' : bgColors,
                        borderRadius: 5,
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type !== 'bar', position: 'bottom' },
                        tooltip: { 
                            callbacks: { 
                                label: c => ` ${c.label}: ${formatWithCommas(c.raw)} ریال` 
                            } 
                        }
                    },
                    scales: (type === 'doughnut' || type === 'pie') ? {} : {
                        y: { ticks: { callback: v => formatAxis(v) }, grid: { borderDash: [5,5] } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderTimelineChart(id, data) {
            const dates = {};
            data.forEach(d => {
                const m = d.date.length >= 7 ? d.date.substring(0, 7) : 'نامشخص';
                if(m !== 'نامشخص') dates[m] = (dates[m]||0) + d.amount;
            });
            const sorted = Object.keys(dates).sort();
            
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'line',
                data: {
                    labels: sorted,
                    datasets: [{
                        label: 'هزینه (ریال)',
                        data: sorted.map(d => dates[d]),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true, tension: 0.4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: { callbacks: { label: c => ` هزینه: ${formatWithCommas(c.raw)} ریال` } } 
                    },
                    scales: { y: { ticks: { callback: v => formatAxis(v) } } }
                }
            });
        }

        function renderHorizontalChart(id, data, key) {
            const counts = {};
            data.forEach(d => counts[d[key]] = (counts[d[key]]||0) + d.amount);
            const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0, 5);
            
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'bar',
                data: {
                    labels: sorted.map(x => x[0]),
                    datasets: [{
                        label: 'مبلغ (ریال)',
                        data: sorted.map(x => x[1]),
                        backgroundColor: '#0ea5e9', borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ` ${c.label}: ${formatWithCommas(c.raw)} ریال` } } },
                    scales: { x: { ticks: { callback: v => formatAxis(v) } } }
                }
            });
        }

        function renderAnalysis(data, totalExp, riskRatio) {
            const container = document.getElementById('risk-alerts-content');
            container.innerHTML = '';
            
            let rClass = riskRatio > 30 ? 'bg-red-50 border-red-500 text-red-800' : (riskRatio > 15 ? 'bg-amber-50 border-amber-500 text-amber-800' : 'bg-emerald-50 border-emerald-500 text-emerald-800');
            let rIcon = riskRatio > 30 ? 'fa-exclamation-triangle' : 'fa-check-circle';
            
            container.innerHTML += `
                <div class="card border-l-4 ${rClass}">
                    <div class="flex items-start gap-3">
                        <i class="fas ${rIcon} text-xl mt-1"></i>
                        <div>
                            <h4 class="font-bold mb-1">شاخص سلامت فرآیند</h4>
                            <p class="text-sm opacity-90">${riskRatio}% حجم معاملات بدون تشریفات بوده است.</p>
                        </div>
                    </div>
                </div>`;

            const vendors = {};
            data.forEach(d => vendors[d.vendor] = (vendors[d.vendor]||0) + d.amount);
            const top = Object.entries(vendors).sort((a,b)=>b[1]-a[1])[0];
            
            if(top) {
                const dep = Math.round((top[1]/totalExp)*100);
                container.innerHTML += `
                    <div class="card border-l-4 ${dep > 25 ? 'bg-blue-50 border-blue-500 text-blue-800' : 'bg-slate-50 border-slate-400 text-slate-700'}">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-handshake text-xl mt-1"></i>
                            <div>
                                <h4 class="font-bold mb-1">تمرکز تأمین (${top[0]})</h4>
                                <p class="text-sm opacity-90">این پیمانکار ${dep}% از کل بودجه خرید را به خود اختصاص داده است.</p>
                            </div>
                        </div>
                    </div>`;
            }
        }

        function showError(msg) { document.getElementById('error-msg').innerText = msg; document.getElementById('error-msg').classList.remove('hidden'); }
    </script>
</body>
</html>
