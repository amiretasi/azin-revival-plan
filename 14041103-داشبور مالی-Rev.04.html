<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ù‡Ø¯Ø§Øª Ù…Ø§Ù„ÛŒ | Ù†Ø³Ø®Ù‡ Ø§Ø¬Ø±Ø§ÛŒÛŒ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;800&display=swap');
        
        body, input, select, button, table {
            font-family: 'Vazirmatn', sans-serif !important;
        }
        
        body {
            background-color: #f8fafc;
            color: #1e293b;
        }

        /* Number Font Specific Fix */
        .num-font {
            font-family: 'Vazirmatn', sans-serif;
            font-feature-settings: "ss01";
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        .sort-icon {
            transition: transform 0.2s;
            display: inline-block;
            margin-right: 4px;
            opacity: 0.5;
        }
        .sort-active {
            opacity: 1;
            color: #2563eb;
        }
        th {
            cursor: pointer;
            user-select: none;
        }
        th:hover {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-5 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <i data-lucide="shield-alert" class="text-red-500"></i>
                    Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¹Ù‡Ø¯Ø§Øª
                </h1>
                <p class="text-slate-400 text-xs mt-1 mr-8">ÙˆÛŒÚ˜Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø´Ø¯ | ØªØ­Ù„ÛŒÙ„ Ø±ÛŒØ³Ú© Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ</p>
            </div>
            <div class="flex items-center gap-4">
                <span id="currentDate" class="text-xs opacity-70 font-mono hidden md:block"></span>
                <button onclick="resetApp()" class="text-sm bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg transition flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6 space-y-8">

        <!-- Upload Section -->
        <div id="uploadSection" class="bg-white p-10 rounded-2xl shadow-xl border-2 border-dashed border-blue-200 text-center transition-all hover:bg-blue-50">
            <div class="flex flex-col items-center justify-center cursor-pointer relative h-48">
                <input type="file" id="csvInput" accept=".csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleFileUpload(this)">
                <i data-lucide="upload-cloud" class="w-20 h-20 text-blue-500 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-700">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ (CSV)</h3>
                <p class="text-gray-500 mt-2 max-w-md mx-auto">
                    ÙØ§ÛŒÙ„ Ø®Ø±ÙˆØ¬ÛŒ Ø³ÛŒØ³ØªÙ… Ù…Ø§Ù„ÛŒ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø±Ù‡Ø§ Ú©Ù†ÛŒØ¯.<br>
                    <span class="text-xs text-gray-400 font-light">(ÙØ±Ù…Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯: Ø±Ø¯ÛŒÙØŒ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù…ÙˆØ¶ÙˆØ¹ØŒ Ù…Ø¨Ù„ØºØŒ Ø³Ø§Ù„...)</span>
                </p>
            </div>
            <div class="mt-6 bg-blue-50 text-blue-800 p-4 rounded-lg border-r-4 border-blue-600 text-right text-sm">
                <strong>Ù†Ú©ØªÙ‡ ÙÙ†ÛŒ:</strong> Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù…Ù† Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Û² Ø®Ø· Ø§ÙˆÙ„ ÙØ§ÛŒÙ„ (Ù‡Ø¯Ø±) Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden space-y-8">
            
            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Total Debt -->
                <div class="bg-white p-6 rounded-xl shadow-md border-r-4 border-blue-500 flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-sm font-medium mb-1">Ú©Ù„ ØªØ¹Ù‡Ø¯Ø§Øª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡</p>
                        <h3 class="text-2xl font-bold text-gray-800 num-font" id="kpiTotal">0 <span class="text-xs text-gray-400 font-normal">Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ Ø±ÛŒØ§Ù„</span></h3>
                    </div>
                    <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                        <i data-lucide="dollar-sign" class="w-8 h-8"></i>
                    </div>
                </div>

                <!-- Critical Debt -->
                <div class="bg-white p-6 rounded-xl shadow-md border-r-4 border-red-600 flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-sm font-medium mb-1">Ø¨Ø¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ø­ÛŒØ§ØªÛŒ (Ø±ÛŒØ³Ú© ØªÙˆÙ‚Ù)</p>
                        <h3 class="text-2xl font-bold text-gray-800 num-font" id="kpiCritical">0 <span class="text-xs text-gray-400 font-normal">Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ Ø±ÛŒØ§Ù„</span></h3>
                        <p class="text-xs text-red-500 mt-1 font-bold" id="kpiCriticalCount">0 Ù…ÙˆØ±Ø¯ ÙÙˆØ±ÛŒ</p>
                    </div>
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                    </div>
                </div>

                <!-- Liquidity Needed -->
                <div class="bg-white p-6 rounded-xl shadow-md border-r-4 border-emerald-500 flex justify-between items-center">
                    <div>
                        <p class="text-gray-500 text-sm font-medium mb-1">Ø¨Ø±Ø¢ÙˆØ±Ø¯ Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²</p>
                        <h3 class="text-2xl font-bold text-gray-800 num-font" id="kpiLiquidity">0 <span class="text-xs text-gray-400 font-normal">Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ Ø±ÛŒØ§Ù„</span></h3>
                        <p class="text-xs text-gray-400 mt-1">ØªØ®Ù…ÛŒÙ†ÛŒ Ø¬Ù‡Øª Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ±ÛŒØ²ÛŒ</p>
                    </div>
                    <div class="p-3 rounded-full bg-emerald-100 text-emerald-600">
                        <i data-lucide="briefcase" class="w-8 h-8"></i>
                    </div>
                </div>
            </div>

            <!-- Global Filters & Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Global Filters Panel -->
                <div class="bg-white p-6 rounded-xl shadow-md lg:col-span-1 space-y-4">
                    <h3 class="font-bold text-gray-700 flex items-center gap-2 border-b pb-3 mb-2">
                        <i data-lucide="filter" class="w-5 h-5"></i> ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ú©Ù„Ø§Ù† (Ø¯ÙˆØ±Ù‡ Ù…Ø§Ù„ÛŒ)
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Ø³Ø§Ù„ Ù…Ø§Ù„ÛŒ</label>
                            <select id="yearFilter" onchange="applyFilters()" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50 text-sm font-medium">
                                <option value="Ù‡Ù…Ù‡">Ù‡Ù…Ù‡ Ø³Ø§Ù„â€ŒÙ‡Ø§</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">Ù…Ø§Ù‡ Ø³Ø±Ø±Ø³ÛŒØ¯</label>
                            <select id="monthFilter" onchange="applyFilters()" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50 text-sm font-medium">
                                <option value="Ù‡Ù…Ù‡">Ù‡Ù…Ù‡ Ù…Ø§Ù‡â€ŒÙ‡Ø§</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ Ø¨Ø¯Ù‡ÛŒ</label>
                        <select id="categoryFilter" onchange="applyFilters()" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50 text-sm font-medium">
                            <option value="Ù‡Ù…Ù‡">Ù‡Ù…Ù‡ Ù…ÙˆØ§Ø±Ø¯</option>
                        </select>
                    </div>
                </div>

                <!-- Chart Container -->
                <div class="bg-white p-6 rounded-xl shadow-md lg:col-span-2">
                    <h3 class="font-bold text-gray-700 mb-4">ØªÙˆØ²ÛŒØ¹ Ø¨Ø¯Ù‡ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ÙˆØ¶ÙˆØ¹ (Ø±ÛŒØ§Ù„)</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="debtChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table with Quick Filters -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                
                <!-- Quick Filter & Sort Toolbar -->
                <div class="p-5 border-b border-gray-200 bg-gray-50">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        <h3 class="font-bold text-gray-800 text-lg whitespace-nowrap">Ù„ÛŒØ³Øª Ø¹Ù…Ù„ÛŒØ§ØªÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</h3>
                        
                        <div class="flex flex-wrap items-center gap-3 w-full md:w-auto justify-end">
                            <!-- Quick Sort -->
                            <div class="relative">
                                <select id="quickSort" onchange="handleQuickSort(this.value)" class="pl-3 pr-8 py-2 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 hover:border-blue-400 transition cursor-pointer">
                                    <option value="date-asc">ğŸ“… ØªØ±ØªÛŒØ¨: Ø³Ø±Ø±Ø³ÛŒØ¯ (Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ±ÛŒÙ†)</option>
                                    <option value="priority-desc">âš ï¸ ØªØ±ØªÛŒØ¨: Ø±ÛŒØ³Ú© (Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ†)</option>
                                    <option value="amount-desc">ğŸ’° ØªØ±ØªÛŒØ¨: Ù…Ø¨Ù„Øº (Ø¨ÛŒØ´ØªØ±ÛŒÙ†)</option>
                                </select>
                            </div>

                            <!-- Quick Priority Filter -->
                            <div class="relative">
                                <select id="quickPriority" onchange="applyFilters()" class="pl-3 pr-8 py-2 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 hover:border-blue-400 transition cursor-pointer">
                                    <option value="Ù‡Ù…Ù‡">ğŸ”– Ø§ÙˆÙ„ÙˆÛŒØª: Ù‡Ù…Ù‡</option>
                                    <option value="Ø­ÛŒØ§ØªÛŒ">ğŸ”´ Ø­ÛŒØ§ØªÛŒ (Ø®Ø·Ø± ØªÙˆÙ‚Ù)</option>
                                    <option value="Ø§Ù„Ø²Ø§Ù…ÛŒ">ğŸŸ  Ø§Ù„Ø²Ø§Ù…ÛŒ</option>
                                    <option value="Ù…Ø¹ÙˆÙ‚">ğŸŸ¡ Ù…Ø¹ÙˆÙ‚ Ø³Ù†ÙˆØ§ØªÛŒ</option>
                                    <option value="Ø¹Ø§Ø¯ÛŒ">ğŸ”µ Ø¹Ø§Ø¯ÛŒ</option>
                                </select>
                            </div>

                            <!-- Quick Status Filter -->
                            <div class="relative">
                                <select id="quickStatus" onchange="applyFilters()" class="pl-3 pr-8 py-2 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 hover:border-blue-400 transition cursor-pointer">
                                    <option value="Ù‡Ù…Ù‡">ğŸ“Œ ÙˆØ¶Ø¹ÛŒØª: Ù‡Ù…Ù‡</option>
                                    <option value="Ø¨Ø§ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´ÙˆØ¯">â— Ø¨Ø§ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´ÙˆØ¯</option>
                                    <option value="Ù…Ø¹Ù…ÙˆÙ„ÛŒ">ğŸ”¹ Ù…Ø¹Ù…ÙˆÙ„ÛŒ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-white text-gray-600 font-bold border-b border-gray-200">
                            <tr>
                                <th class="p-4 w-32 group" onclick="sortData('priority')">
                                    Ø§ÙˆÙ„ÙˆÛŒØª <i data-lucide="arrow-up-down" class="w-3 h-3 sort-icon group-hover:text-blue-600" id="sort-priority"></i>
                                </th>
                                <th class="p-4 w-32 group" onclick="sortData('date')">
                                    ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ <i data-lucide="arrow-up-down" class="w-3 h-3 sort-icon group-hover:text-blue-600" id="sort-date"></i>
                                </th>
                                <th class="p-4 group" onclick="sortData('title')">
                                    Ø¹Ù†ÙˆØ§Ù† Ø¨Ø¯Ù‡ÛŒ / ØªÙˆØ¶ÛŒØ­Ø§Øª <i data-lucide="arrow-up-down" class="w-3 h-3 sort-icon group-hover:text-blue-600" id="sort-title"></i>
                                </th>
                                <th class="p-4 w-40 group" onclick="sortData('category')">
                                    Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ <i data-lucide="arrow-up-down" class="w-3 h-3 sort-icon group-hover:text-blue-600" id="sort-category"></i>
                                </th>
                                <th class="p-4 w-32 group" onclick="sortData('status')">
                                    ÙˆØ¶Ø¹ÛŒØª <i data-lucide="arrow-up-down" class="w-3 h-3 sort-icon group-hover:text-blue-600" id="sort-status"></i>
                                </th>
                                <th class="p-4 w-48 text-left group" onclick="sortData('amount')">
                                    Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„) <i data-lucide="arrow-up-down" class="w-3 h-3 sort-icon group-hover:text-blue-600" id="sort-amount"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="divide-y divide-gray-100 bg-white">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
                <div id="noDataMessage" class="hidden p-12 text-center text-gray-400 font-light">
                    Ù…ÙˆØ±Ø¯ÛŒ Ø¨Ø§ Ø§ÛŒÙ† ØªØ±Ú©ÛŒØ¨ ÙÛŒÙ„ØªØ±Ù‡Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯.
                </div>
            </div>

        </div>
    </main>

    <footer class="text-center p-6 text-gray-400 text-xs font-light">
        <p>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ | Ù†Ø³Ø®Ù‡ Û±.Û².Û°</p>
    </footer>

    <!-- LOGIC -->
    <script>
        // --- Global State ---
        let allData = [];
        let filteredData = [];
        let debtChartInstance = null;
        let currentSort = { column: 'date', direction: 'asc' }; // Default sort by Date

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            const today = new Date().toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('currentDate').textContent = today;
        });

        function resetApp() {
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('csvInput').value = '';
            // Reset filters
            document.getElementById('quickSort').value = 'date-asc';
            document.getElementById('quickPriority').value = 'Ù‡Ù…Ù‡';
            document.getElementById('quickStatus').value = 'Ù‡Ù…Ù‡';
            allData = [];
        }

        // --- Parser ---
        function parseCSVLine(text) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else current += char;
            }
            result.push(current);
            return result.map(val => val.trim().replace(/^"|"$/g, '')); 
        }

        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/);
            const headerIndex = lines.findIndex(line => line.includes('Ø±Ø¯ÛŒÙ') && line.includes('Ø¹Ù†ÙˆØ§Ù† Ø¨Ø¯Ù‡ÛŒ'));
            if (headerIndex === -1) return [];

            const headers = parseCSVLine(lines[headerIndex]);
            const data = [];

            for (let i = headerIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = parseCSVLine(line);
                if (values.length >= 4) { 
                    const row = {};
                    headers.forEach((h, index) => {
                        if (values[index] !== undefined) row[h.trim()] = values[index];
                    });
                    data.push(row);
                }
            }
            return data;
        }

        function parseAmount(str) {
            if (!str) return 0;
            let cleanStr = str.toString().replace(/,/g, '');
            const persianDigits = [/Û°/g, /Û±/g, /Û²/g, /Û³/g, /Û´/g, /Ûµ/g, /Û¶/g, /Û·/g, /Û¸/g, /Û¹/g];
            const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            for (let i = 0; i < 10; i++) {
                cleanStr = cleanStr.replace(persianDigits[i], englishDigits[i]);
            }
            return parseInt(cleanStr, 10) || 0;
        }

        function formatCurrency(num) {
            // Returns Persian digits with commas
            return new Intl.NumberFormat('fa-IR').format(num);
        }

        function formatBillion(num) {
            // Converts to Billion and formats with Persian digits
            const billions = num / 1000000000;
            return new Intl.NumberFormat('fa-IR', { minimumFractionDigits: 3, maximumFractionDigits: 3 }).format(billions);
        }

        // --- Logic ---
        function getPriorityInfo(item) {
            let score = 0;
            const subject = item['Ù…ÙˆØ¶ÙˆØ¹'] || '';
            const status = item['ÙˆØ¶Ø¹ÛŒØª'] || '';
            const desc = item['ØªÙˆØ¶ÛŒØ­Ø§Øª'] || '';
            const year = parseInt(item['Ø³Ø§Ù„'] || 0);

            if (subject.includes('Ù…Ø§Ù„ÛŒØ§Øª') || subject.includes('Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡')) score += 1000;
            if (subject.includes('Ø¨ÛŒÙ…Ù‡')) score += 900;
            if (status.includes('Ø¨Ø§ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´ÙˆØ¯')) score += 500;
            if (year > 0 && year < 1403) score += 200;
            if (desc.includes('Ù¾ÙˆÙ„Ø´ÙˆÛŒÛŒ') || desc.includes('Ø§Ø¬Ø±Ø§ÛŒÛŒÙ‡')) score += 2000;

            if (score >= 900) return { score, label: 'Ø­ÛŒØ§ØªÛŒ', colorClass: 'bg-red-600 text-white', level: 'Critical' };
            if (score >= 500) return { score, label: 'Ø§Ù„Ø²Ø§Ù…ÛŒ', colorClass: 'bg-orange-500 text-white', level: 'High' };
            if (score >= 200) return { score, label: 'Ù…Ø¹ÙˆÙ‚', colorClass: 'bg-yellow-500 text-black', level: 'Medium' };
            return { score, label: 'Ø¹Ø§Ø¯ÛŒ', colorClass: 'bg-blue-100 text-blue-800', level: 'Low' };
        }

        // --- Handlers ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const rawData = parseCSV(text);
                    
                    allData = rawData.map((item, index) => {
                        if (!item['Ø¹Ù†ÙˆØ§Ù† Ø¨Ø¯Ù‡ÛŒ'] || !item['Ù…Ø¨Ù„Øº']) return null;
                        return {
                            ...item,
                            id: index,
                            parsedAmount: parseAmount(item['Ù…Ø¨Ù„Øº']),
                            priority: getPriorityInfo(item),
                            sortDate: item['ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯'] || '9999/99/99' // For sorting
                        };
                    }).filter(item => item !== null);

                    if (allData.length === 0) {
                        alert('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.');
                        return;
                    }

                    populateFilters();
                    // Reset Quick Filters
                    document.getElementById('quickSort').value = 'date-asc';
                    currentSort = { column: 'date', direction: 'asc' };
                    
                    applyFilters();

                    document.getElementById('uploadSection').classList.add('hidden');
                    document.getElementById('dashboardContent').classList.remove('hidden');
                } catch (err) {
                    console.error(err);
                    alert('Ø®Ø·Ø§ Ø¯Ø± ÙØ§ÛŒÙ„');
                }
            };
            reader.readAsText(file);
        }

        function populateFilters() {
            const years = [...new Set(allData.map(d => d['Ø³Ø§Ù„']).filter(Boolean))].sort();
            const months = [...new Set(allData.map(d => d['Ù…Ø§Ù‡']).filter(Boolean))];
            const categories = [...new Set(allData.map(d => d['Ù…ÙˆØ¶ÙˆØ¹']).filter(Boolean))];

            const yearSelect = document.getElementById('yearFilter');
            const monthSelect = document.getElementById('monthFilter');
            const catSelect = document.getElementById('categoryFilter');

            yearSelect.innerHTML = '<option value="Ù‡Ù…Ù‡">Ù‡Ù…Ù‡ Ø³Ø§Ù„â€ŒÙ‡Ø§</option>';
            monthSelect.innerHTML = '<option value="Ù‡Ù…Ù‡">Ù‡Ù…Ù‡ Ù…Ø§Ù‡â€ŒÙ‡Ø§</option>';
            catSelect.innerHTML = '<option value="Ù‡Ù…Ù‡">Ù‡Ù…Ù‡ Ù…ÙˆØ§Ø±Ø¯</option>';

            years.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            });

            months.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                monthSelect.appendChild(opt);
            });

            categories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                catSelect.appendChild(opt);
            });
        }

        function handleQuickSort(value) {
            // Helper to map dropdown values to sort function logic
            const [column, direction] = value.split('-');
            currentSort = { column, direction };
            
            // Visual Update for header icons
            document.querySelectorAll('.sort-icon').forEach(el => {
                el.classList.remove('sort-active', 'text-blue-600');
                el.style.transform = 'rotate(0deg)';
            });
            const activeIcon = document.getElementById(`sort-${column}`);
            if (activeIcon) {
                activeIcon.classList.add('sort-active');
                if (direction === 'desc') {
                    activeIcon.style.transform = 'rotate(180deg)';
                }
            }

            doSort();
            renderTable();
        }

        function applyFilters() {
            // Global Filters
            const selectedYear = document.getElementById('yearFilter').value;
            const selectedMonth = document.getElementById('monthFilter').value;
            const selectedCategory = document.getElementById('categoryFilter').value;

            // Quick Filters (Table level)
            const quickStatus = document.getElementById('quickStatus').value;
            const quickPriority = document.getElementById('quickPriority').value;

            filteredData = allData.filter(item => {
                // Global Checks
                const matchYear = selectedYear === 'Ù‡Ù…Ù‡' || item['Ø³Ø§Ù„'] === selectedYear;
                const matchMonth = selectedMonth === 'Ù‡Ù…Ù‡' || item['Ù…Ø§Ù‡'] === selectedMonth;
                const matchCat = selectedCategory === 'Ù‡Ù…Ù‡' || item['Ù…ÙˆØ¶ÙˆØ¹'] === selectedCategory;

                // Quick Checks
                const matchStatus = quickStatus === 'Ù‡Ù…Ù‡' || (item['ÙˆØ¶Ø¹ÛŒØª'] && item['ÙˆØ¶Ø¹ÛŒØª'].includes(quickStatus));
                const matchPriority = quickPriority === 'Ù‡Ù…Ù‡' || (item.priority && item.priority.label.includes(quickPriority));

                return matchYear && matchMonth && matchCat && matchStatus && matchPriority;
            });

            // Re-apply sorting based on current sort state (could be from headers or dropdown)
            doSort(); 
            updateUI();
        }

        // --- Sorting ---
        function sortData(column) {
            // Toggle direction if clicking same column
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc'; // Default new sort to asc
                // Exception: Priority and Amount usually wanted Descending first
                if (column === 'priority' || column === 'amount') currentSort.direction = 'desc';
            }
            
            // Sync dropdown if possible (optional UI polish)
            const syncVal = `${column}-${currentSort.direction}`;
            const dropdown = document.getElementById('quickSort');
            if(dropdown.querySelector(`option[value="${syncVal}"]`)) {
                dropdown.value = syncVal;
            }

            // Update Icons UI
            document.querySelectorAll('.sort-icon').forEach(el => {
                el.classList.remove('sort-active', 'text-blue-600');
                el.style.transform = 'rotate(0deg)';
            });
            const activeIcon = document.getElementById(`sort-${column}`);
            if (activeIcon) {
                activeIcon.classList.add('sort-active');
                if (currentSort.direction === 'desc') {
                    activeIcon.style.transform = 'rotate(180deg)';
                }
            }

            doSort();
            renderTable(); // Re-render just the table
        }

        function doSort() {
            filteredData.sort((a, b) => {
                let valA, valB;

                switch(currentSort.column) {
                    case 'date':
                        valA = a.sortDate;
                        valB = b.sortDate;
                        break;
                    case 'priority':
                        valA = a.priority.score;
                        valB = b.priority.score;
                        break;
                    case 'amount':
                        valA = a.parsedAmount;
                        valB = b.parsedAmount;
                        break;
                    case 'category':
                        valA = a['Ù…ÙˆØ¶ÙˆØ¹'] || '';
                        valB = b['Ù…ÙˆØ¶ÙˆØ¹'] || '';
                        break;
                    case 'status':
                        valA = a['ÙˆØ¶Ø¹ÛŒØª'] || '';
                        valB = b['ÙˆØ¶Ø¹ÛŒØª'] || '';
                        break;
                    case 'title':
                        valA = a['Ø¹Ù†ÙˆØ§Ù† Ø¨Ø¯Ù‡ÛŒ'] || '';
                        valB = b['Ø¹Ù†ÙˆØ§Ù† Ø¨Ø¯Ù‡ÛŒ'] || '';
                        break;
                    default:
                        return 0;
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // --- UI Updates ---
        function updateUI() {
            // KPIs in Billion Rials
            const totalDebt = filteredData.reduce((sum, item) => sum + item.parsedAmount, 0);
            const criticalItems = filteredData.filter(i => i.priority.level === 'Critical');
            const criticalDebt = criticalItems.reduce((sum, item) => sum + item.parsedAmount, 0);

            // Use formatBillion helper
            document.getElementById('kpiTotal').innerHTML = `${formatBillion(totalDebt)} <span class="text-xs text-gray-400 font-normal">Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ Ø±ÛŒØ§Ù„</span>`;
            document.getElementById('kpiCritical').innerHTML = `${formatBillion(criticalDebt)} <span class="text-xs text-gray-400 font-normal">Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ Ø±ÛŒØ§Ù„</span>`;
            document.getElementById('kpiCriticalCount').textContent = `${criticalItems.length} Ù…ÙˆØ±Ø¯ ÙÙˆØ±ÛŒ`;
            document.getElementById('kpiLiquidity').innerHTML = `${formatBillion(totalDebt)} <span class="text-xs text-gray-400 font-normal">Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ Ø±ÛŒØ§Ù„</span>`;

            renderTable();
            updateChart();
        }

        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            if (filteredData.length === 0) {
                document.getElementById('noDataMessage').classList.remove('hidden');
                return;
            }

            document.getElementById('noDataMessage').classList.add('hidden');
            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50 transition-colors border-b border-gray-50';
                tr.innerHTML = `
                    <td class="p-4">
                        <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-bold shadow-sm ${row.priority.colorClass}">
                            ${row.priority.label}
                        </span>
                    </td>
                    <td class="p-4 font-mono text-xs text-gray-600 num-font">
                        ${row['ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯'] || 'Ù†Ø§Ù…Ø´Ø®Øµ'}
                    </td>
                    <td class="p-4">
                        <div class="font-bold text-gray-700 text-sm">${row['Ø¹Ù†ÙˆØ§Ù† Ø¨Ø¯Ù‡ÛŒ']}</div>
                        <div class="text-xs text-gray-400 mt-1 truncate max-w-xs">${row['ØªÙˆØ¶ÛŒØ­Ø§Øª'] || ''}</div>
                    </td>
                    <td class="p-4">
                        <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-medium border border-gray-200">
                            ${row['Ù…ÙˆØ¶ÙˆØ¹']}
                        </span>
                    </td>
                    <td class="p-4">
                        ${row['ÙˆØ¶Ø¹ÛŒØª'] === 'Ø¨Ø§ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´ÙˆØ¯' 
                            ? '<span class="text-red-600 font-bold text-xs flex items-center gap-1"><i data-lucide="alert-circle" class="w-3 h-3"></i> Ø§Ù„Ø²Ø§Ù…ÛŒ</span>' 
                            : '<span class="text-gray-400 text-xs">Ø¹Ø§Ø¯ÛŒ</span>'}
                    </td>
                    <td class="p-4 text-left font-bold text-gray-800 dir-ltr text-sm num-font">
                        ${formatCurrency(row.parsedAmount)}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function updateChart() {
            const ctx = document.getElementById('debtChart').getContext('2d');
            const subjectMap = {};
            filteredData.forEach(item => {
                const sub = item['Ù…ÙˆØ¶ÙˆØ¹'] || 'Ø³Ø§ÛŒØ±';
                subjectMap[sub] = (subjectMap[sub] || 0) + item.parsedAmount;
            });
            const labels = Object.keys(subjectMap).sort((a, b) => subjectMap[b] - subjectMap[a]);
            const values = labels.map(l => subjectMap[l]);

            if (debtChartInstance) debtChartInstance.destroy();

            debtChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ù…Ø¨Ù„Øº Ø¨Ø¯Ù‡ÛŒ (Ø±ÛŒØ§Ù„)',
                        data: values,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4,
                        barThickness: 20,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            bodyFont: { family: 'Vazirmatn' },
                            titleFont: { family: 'Vazirmatn' },
                            callbacks: {
                                label: function(context) { return formatCurrency(context.raw) + ' Ø±ÛŒØ§Ù„'; }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: { family: 'Vazirmatn' },
                                callback: function(value) { return (value / 1000000000).toFixed(1) + ' B'; }
                            },
                            grid: { display: false }
                        },
                        y: { ticks: { font: { family: 'Vazirmatn', size: 11, weight: 'bold' } } }
                    }
                }
            });
        }
    </script>
</body>
</html>