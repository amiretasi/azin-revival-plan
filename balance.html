<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¬Ø§Ù…Ø¹ Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ (Rev.13 Final)</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --font-main: 'Vazirmatn', sans-serif; }
        body { font-family: var(--font-main); background-color: #f8fafc; color: #0f172a; }
        
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .card { background: white; border-radius: 16px; box-shadow: 0 4px 20px -2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; padding: 1.5rem; }
        .btn-upload { transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-upload:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .font-num { font-feature-settings: "ss01"; font-family: var(--font-main); }
        
        /* Table Styles */
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th { position: sticky; z-index: 20; color: white; text-align: center; border: 1px solid #334155; }
        thead tr:first-child th { top: 0; height: 40px; background-color: #0f172a; font-size: 0.8rem; }
        thead tr:nth-child(2) th { top: 40px; height: 35px; background-color: #334155; font-size: 0.75rem; }
        td { padding: 8px 4px; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; font-size: 0.8rem; white-space: nowrap; text-align: center; }
        tr:hover td { background-color: #f1f5f9; }
        tfoot th, tfoot td { position: sticky; bottom: 0; z-index: 20; background-color: #e2e8f0; border-top: 2px solid #94a3b8; font-weight: 800; color: #0f172a; text-align: center; }
        
        .input-group:focus-within label { color: #3b82f6; }
        .input-group:focus-within input { border-color: #3b82f6; ring: 2px; }
        
        .bg-sales { background-color: #eff6ff; }
        .bg-due { background-color: #fff1f2; }
        .bg-paid { background-color: #ecfdf5; }
        .text-neg { color: #dc2626; direction: ltr; } 
        .text-pos { color: #16a34a; direction: ltr; }
    </style>
</head>
<body class="p-4 md:p-8 space-y-6 bg-slate-50">

    <!-- Header & KPIs -->
    <div class="space-y-4">
        <!-- Top Bar -->
        <div class="card border-r-4 border-slate-800 flex flex-col lg:flex-row justify-between items-center gap-4 py-4">
            <div>
                <h1 class="text-2xl font-black text-slate-800 tracking-tight">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¬Ø§Ù…Ø¹ ØªØ±Ø§Ø² Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ</h1>
                <p id="updateTime" class="text-sm text-slate-500 mt-1 font-bold font-num flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    ...
                </p>
            </div>
            <div class="flex gap-2">
                <label class="btn-upload bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 cursor-pointer">
                    <input type="file" id="fileSales" accept=".csv" class="hidden" />
                    <span id="lblSales">ğŸ“‚ ÙØ§ÛŒÙ„ ÙØ±ÙˆØ´</span>
                </label>
                <label class="btn-upload bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 cursor-pointer">
                    <input type="file" id="fileReceipts" accept=".csv" class="hidden" />
                    <span id="lblReceipts">ğŸ“‚ ÙØ§ÛŒÙ„ ÙˆØ±ÙˆØ¯ÛŒ</span>
                </label>
            </div>
        </div>

        <!-- 5 Strategic KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
            <!-- 1. Total Contract Sales -->
            <div class="card p-4 border-t-4 border-gray-500 flex flex-col justify-center items-center">
                <span class="text-[10px] font-bold text-gray-500 mb-1">Ù…ÛŒØ²Ø§Ù† ØªØ¬Ù…Ø¹ÛŒ Ú©Ù„ ÙØ±ÙˆØ´</span>
                <span class="text-xl font-black text-gray-800 font-num dir-ltr" id="kpiTotalSales">0</span>
                <span class="text-[9px] text-gray-400 mt-1">Ø§Ø±Ø²Ø´ Ú©Ù„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ (Total)</span>
            </div>
            <!-- 2. Share Sales -->
            <div class="card p-4 border-t-4 border-blue-600 flex flex-col justify-center items-center bg-blue-50/50">
                <span class="text-[10px] font-bold text-blue-600 mb-1">Ù…ÛŒØ²Ø§Ù† ÙØ±ÙˆØ´ Ø³Ù‡Ù…</span>
                <span class="text-xl font-black text-blue-800 font-num dir-ltr" id="kpiShareSales">0</span>
                <span class="text-[9px] text-blue-400 mt-1">Ø³Ù‡Ù… Ø´Ø±Ú©Øª (Revenue)</span>
            </div>
            <!-- 3. Matured Due -->
            <div class="card p-4 border-t-4 border-pink-600 flex flex-col justify-center items-center">
                <span class="text-[10px] font-bold text-pink-600 mb-1">Ù…ÛŒØ²Ø§Ù† Ø³Ø±Ø±Ø³ÛŒØ¯ Ù…Ø·Ø§Ù„Ø¨Ø§Øª</span>
                <span class="text-xl font-black text-pink-800 font-num dir-ltr" id="kpiDue">0</span>
                <span class="text-[9px] text-pink-400 mt-1">ØªØ¹Ù‡Ø¯Ø§Øª Ø³Ø±Ø±Ø³ÛŒØ¯ Ø´Ø¯Ù‡</span>
            </div>
            <!-- 4. Total Paid -->
            <div class="card p-4 border-t-4 border-emerald-600 flex flex-col justify-center items-center">
                <span class="text-[10px] font-bold text-emerald-600 mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</span>
                <span class="text-xl font-black text-emerald-800 font-num dir-ltr" id="kpiPaid">0</span>
                <span class="text-[9px] text-emerald-400 mt-1">ÙˆØ±ÙˆØ¯ÛŒ Ø®Ø²Ø§Ù†Ù‡ (Cash)</span>
            </div>
            <!-- 5. Balance -->
            <div class="card p-4 border-t-4 border-slate-800 flex flex-col justify-center items-center bg-slate-50">
                <span class="text-[10px] font-bold text-slate-600 mb-1">ØªØ±Ø§Ø² Ù†Ù‡Ø§ÛŒÛŒ (Ø§Ù†Ø­Ø±Ø§Ù)</span>
                <span class="text-xl font-black text-slate-900 font-num dir-ltr" id="kpiBalance">0</span>
                <span class="text-[9px] text-slate-400 mt-1">Ø³Ø±Ø±Ø³ÛŒØ¯ - Ù¾Ø±Ø¯Ø§Ø®Øª</span>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="card bg-white sticky top-2 z-30 shadow-md py-4 border-b border-slate-200">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
            <div class="input-group">
                <label class="block text-[10px] font-extrabold text-slate-500 uppercase mb-1">Ù…Ø§Ù†Ø¯Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ø¯ÙˆØ±Ù‡ (Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯)</label>
                <input type="number" id="inpBalance" value="0" class="w-full bg-slate-50 border-2 border-slate-300 rounded-lg px-3 py-2 text-sm font-bold font-num text-slate-800 outline-none transition text-center" placeholder="0" />
            </div>
            <div class="input-group lg:col-span-1">
                <label class="block text-[10px] font-extrabold text-indigo-600 uppercase mb-1">ØªØ§Ø±ÛŒØ® Ù…Ø¨Ù†Ø§ (Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ)</label>
                <select id="currentDateSelect" class="w-full bg-indigo-50 border-2 border-indigo-200 text-indigo-900 rounded-lg px-3 py-2 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition text-center"></select>
            </div>
            <div>
                <label class="block text-[10px] font-extrabold text-slate-400 uppercase mb-1">ÙÛŒÙ„ØªØ± Ø³Ø§Ù„</label>
                <select id="yearSelect" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 transition text-center">
                    <option value="all">ØªÙ…Ø§Ù… Ø³Ø§Ù„â€ŒÙ‡Ø§</option>
                    <option value="1403">Û±Û´Û°Û³</option>
                    <option value="1404" selected>Û±Û´Û°Û´</option>
                </select>
            </div>
            <div class="lg:col-span-2">
                <label class="block text-[10px] font-extrabold text-slate-400 uppercase mb-1">ÙÛŒÙ„ØªØ± Ú©Ø§Ø±ÙØ±Ù…Ø§</label>
                <select id="clientSelect" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 transition text-center">
                    <option value="all">Ù‡Ù…Ù‡ Ú©Ø§Ø±ÙØ±Ù…Ø§ÛŒØ§Ù† (ØªØ¬Ù…Ø¹ÛŒ)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="card h-[450px] relative flex flex-col">
            <h3 class="text-sm font-bold text-slate-700 mb-4 border-b pb-2 text-center">Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ø§Ù‡Ø§Ù†Ù‡: ÙØ±ÙˆØ´ (Ø¨Ø§Ù„Ø§) vs Ù¾Ø±Ø¯Ø§Ø®Øª (Ù¾Ø§ÛŒÛŒÙ†)</h3>
            <div class="flex-grow relative w-full h-full"><canvas id="chartMonthly"></canvas></div>
        </div>
        <div class="card h-[450px] relative flex flex-col">
            <h3 class="text-sm font-bold text-slate-700 mb-4 border-b pb-2 text-center">ØªØ­Ù„ÛŒÙ„ Ø¬Ø§Ù…Ø¹: Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø±ÙˆÙ†Ø¯ Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§</h3>
            <div class="flex-grow relative w-full h-full"><canvas id="chartCumulative"></canvas></div>
        </div>
    </div>

    <!-- Table -->
    <div class="card p-0 overflow-hidden flex flex-col h-[600px]">
        <div class="p-4 border-b border-slate-100 bg-white sticky top-0 z-20 flex justify-between items-center">
            <h3 class="font-bold text-slate-800">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ ØªÙØµÛŒÙ„ÛŒ Ø¬Ø±ÛŒØ§Ù† Ù†Ù‚Ø¯ÛŒÙ†Ú¯ÛŒ</h3>
            <div class="text-xs font-num bg-slate-100 px-2 py-1 rounded border">ÙˆØ§Ø­Ø¯: Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯ Ø±ÛŒØ§Ù„</div>
        </div>
        <div class="flex-grow overflow-auto custom-scroll relative">
            <table class="w-full">
                <thead>
                    <tr>
                        <th rowspan="2" class="w-16">Ø³Ø§Ù„</th>
                        <th rowspan="2" class="w-20">Ù…Ø§Ù‡</th>
                        <th colspan="2" class="bg-blue-900 border-l border-blue-800">ÙØ±ÙˆØ´ Ø³Ù‡Ù… (Ø¯Ø±Ø¢Ù…Ø¯)</th>
                        <th colspan="2" class="bg-pink-900 border-l border-pink-800">ØªØ¹Ù‡Ø¯ Ø³Ø±Ø±Ø³ÛŒØ¯ Ø´Ø¯Ù‡</th>
                        <th colspan="2" class="bg-emerald-900 border-l border-emerald-800">Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ (Ù…Ù†ÙÛŒ)</th>
                        <th rowspan="2" class="w-24 bg-slate-800">ØªØ±Ø§Ø² Ù†Ù‡Ø§ÛŒÛŒ<br><span class="text-[9px] font-light">(ØªØ¬Ù…Ø¹ÛŒ)</span></th>
                    </tr>
                    <tr>
                        <th class="w-20">Ø¯ÙˆØ±Ù‡</th><th class="w-24 border-l border-slate-600">ØªØ¬Ù…Ø¹ÛŒ</th>
                        <th class="w-20">Ø¯ÙˆØ±Ù‡</th><th class="w-24 border-l border-slate-600">ØªØ¬Ù…Ø¹ÛŒ</th>
                        <th class="w-20">Ø¯ÙˆØ±Ù‡</th><th class="w-24 border-l border-slate-600">ØªØ¬Ù…Ø¹ÛŒ</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="font-num font-bold text-slate-600"></tbody>
                <tfoot id="tableFooter"></tfoot>
            </table>
        </div>
    </div>

    <script>
        // --- LIVE DATE ---
        function updateDateDisplay() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', calendar: 'persian' };
            document.getElementById('updateTime').innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: ${now.toLocaleDateString('fa-IR', options)}`;
        }
        setInterval(updateDateDisplay, 1000); updateDateDisplay();

        // --- CHART CONFIG ---
        Chart.defaults.font.family = 'Vazirmatn';
        const FONT_OPTS = { family: 'Vazirmatn', size: 11 };
        
        // --- DATA MAPS ---
        const MONTH_MAP = { "ÙØ±ÙˆØ±Ø¯ÛŒÙ†":1, "Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª":2, "Ø®Ø±Ø¯Ø§Ø¯":3, "ØªÛŒØ±":4, "Ù…Ø±Ø¯Ø§Ø¯":5, "Ø´Ù‡Ø±ÛŒÙˆØ±":6, "Ù…Ù‡Ø±":7, "Ø¢Ø¨Ø§Ù†":8, "Ø§Ø¨Ø§Ù†":8, "Ø¢Ø°Ø±":9, "Ø§Ø°Ø±":9, "Ø¯ÛŒ":10, "Ø¨Ù‡Ù…Ù†":11, "Ø§Ø³ÙÙ†Ø¯":12 };
        const MONTH_NAMES_ARR = ["ÙØ±ÙˆØ±Ø¯ÛŒÙ†", "Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª", "Ø®Ø±Ø¯Ø§Ø¯", "ØªÛŒØ±", "Ù…Ø±Ø¯Ø§Ø¯", "Ø´Ù‡Ø±ÛŒÙˆØ±", "Ù…Ù‡Ø±", "Ø¢Ø¨Ø§Ù†", "Ø¢Ø°Ø±", "Ø¯ÛŒ", "Ø¨Ù‡Ù…Ù†", "Ø§Ø³ÙÙ†Ø¯"];

        let rawSales = []; // Stores {total, share, ...}
        let rawReceipts = [];
        let uniqueClients = new Set();
        let charts = {};

        // --- UTILS ---
        function normalizeClient(name) {
            if (!name) return "Ù†Ø§Ù…Ø´Ø®Øµ";
            const n = name.trim();
            if (n.includes("Ú¯Ø³ØªØ±") || n.includes("Ø³Ø§Ø²Ù‡")) return "Ø³Ø§Ø²Ù‡ Ú¯Ø³ØªØ±";
            if (n.includes("Ø¢Ø±Ù…Ø§Ù†") || n.includes("Ù…ÙˆØªÙˆØ±") && !n.includes("Ø¯ÛŒØ²Ù„")) return "Ø¢Ø±Ù…Ø§Ù† Ù…ÙˆØªÙˆØ±";
            if (n.includes("ÛŒØ¯Ú©")) return "Ø³Ø§ÛŒÙ¾Ø§ ÛŒØ¯Ú©";
            if (n.includes("Ø²Ø§Ù…ÛŒØ§Ø¯")) return "Ø²Ø§Ù…ÛŒØ§Ø¯";
            if (n.includes("Ù‚Ø§Ù„Ø¨")) return "Ù‚Ø§Ù„Ø¨Ù‡Ø§ÛŒ ØµÙ†Ø¹ØªÛŒ";
            if (n.includes("Ø³ÙˆØ¯ÛŒÚ©Ùˆ")) return "Ø³ÙˆØ¯ÛŒÚ©Ùˆ";
            return n;
        }
        function getLagForClient(c) { return (c && c.includes('Ø²Ø§Ù…ÛŒØ§Ø¯')) ? 4 : 5; }

        // --- INIT TIME SELECTOR ---
        function initTimeSelector() {
            const sel = document.getElementById('currentDateSelect');
            [1403, 1404].forEach(y => {
                MONTH_NAMES_ARR.forEach((m, idx) => {
                    const opt = document.createElement('option');
                    opt.value = (y * 12) + (idx + 1);
                    opt.text = `${m} ${y}`;
                    if (y === 1404 && idx === 9) opt.selected = true; 
                    sel.appendChild(opt);
                });
            });
            sel.addEventListener('change', runAnalysis);
        }

        // --- PARSER (Enhanced to read Total & Share) ---
        function parseFile(file, type) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const lines = e.target.result.split('\n');
                    const parsed = [];
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        const parts = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                        if (!parts) continue;
                        const clean = (v) => v ? v.replace(/["',]/g, '').trim() : "";
                        try {
                            if (type === 'sales') {
                                if (parts.length < 7) continue;
                                const y = parseInt(clean(parts[1]));
                                const mStr = clean(parts[2]);
                                const client = normalizeClient(clean(parts[3]));
                                const totalVal = parseFloat(clean(parts[5])); // NEW: Col 5 is Total
                                const shareVal = parseFloat(clean(parts[6])); // Col 6 is Share
                                if (!isNaN(y) && !isNaN(shareVal)) {
                                    parsed.push({ 
                                        y, m: mStr, client, 
                                        total: totalVal / 1000, 
                                        amount: shareVal / 1000, // Using Share as main amount for logic
                                        idx: (y * 12) + MONTH_MAP[mStr] 
                                    });
                                    uniqueClients.add(client);
                                }
                            } else {
                                if (parts.length < 6) continue;
                                const mStr = clean(parts[0]);
                                const client = normalizeClient(clean(parts[1]));
                                const valRaw = parseFloat(clean(parts[4]));
                                const dateStr = clean(parts[5]);
                                let y = 1403;
                                if (dateStr.includes('.')) y = parseInt(dateStr.split('.')[0]);
                                else if (dateStr.includes('/')) y = parseInt(dateStr.split('/')[0]);
                                if (!isNaN(valRaw)) {
                                    parsed.push({ 
                                        y, m: mStr, client, 
                                        amount: valRaw / 1000000000, 
                                        idx: (y * 12) + MONTH_MAP[mStr] 
                                    });
                                    uniqueClients.add(client);
                                }
                            }
                        } catch (err) { console.error(err); }
                    }
                    resolve(parsed);
                };
                reader.readAsText(file);
            });
        }

        // --- CORE ANALYSIS ---
        function runAnalysis() {
            const client = document.getElementById('clientSelect').value;
            const year = document.getElementById('yearSelect').value;
            const opBal = parseFloat(document.getElementById('inpBalance').value) || 0;
            const curIdx = parseInt(document.getElementById('currentDateSelect').value);
            
            // 1. Filter Data
            let sFiltered = client === 'all' ? rawSales : rawSales.filter(d => d.client === client);
            let rFiltered = client === 'all' ? rawReceipts : rawReceipts.filter(d => d.client === client);

            // 2. Determine Timeline Range
            const allIdx = new Set([...rawSales.map(d=>d.idx), ...rawReceipts.map(d=>d.idx)]);
            const sortedIdx = Array.from(allIdx).sort((a,b)=>a-b);
            
            let minIndex = 0, maxIndex = 0;
            if (year !== 'all') {
                const yInt = parseInt(year);
                minIndex = (yInt * 12) + 1; maxIndex = (yInt * 12) + 12;
            } else {
                minIndex = sortedIdx.length ? sortedIdx[0] : curIdx;
                maxIndex = Math.max(sortedIdx.length ? sortedIdx[sortedIdx.length-1] : curIdx, curIdx);
            }

            // 3. Build Map & Calculate KPIs
            const timeMap = {};
            let kpi_TotalSales = 0; // Cumulative Total Contract
            let kpi_ShareSales = 0; // Cumulative Share (includes opBal logic later)
            
            // Init Map
            for (let idx = minIndex; idx <= maxIndex; idx++) {
                const y = Math.floor((idx-1)/12);
                const mIdx = ((idx-1)%12) + 1;
                const mName = Object.keys(MONTH_MAP).find(k => MONTH_MAP[k] === mIdx && k !== 'Ø§Ø¨Ø§Ù†' && k !== 'Ø§Ø°Ø±');
                timeMap[idx] = { y, m: mName, s: 0, r: 0, due: 0 };
            }

            // Inject Opening Balance (Due at minIndex+2)
            if (opBal !== 0 && timeMap[minIndex + 2]) {
                timeMap[minIndex + 2].due += opBal;
            }

            // Populate Sales & Receipts
            sFiltered.forEach(d => { 
                if(timeMap[d.idx]) {
                    timeMap[d.idx].s += d.amount; // Share amount for chart/table
                    // Add to KPI if this month is within selected range (or all)
                    if (year === 'all' || d.y === parseInt(year)) {
                        kpi_TotalSales += d.total || 0;
                    }
                }
            });
            rFiltered.forEach(d => { if(timeMap[d.idx]) timeMap[d.idx].r += d.amount; });

            // Calculate Due
            sFiltered.forEach(s => {
                const dueIdx = s.idx + getLagForClient(s.client);
                if (timeMap[dueIdx] && dueIdx <= curIdx) {
                    timeMap[dueIdx].due += s.amount;
                }
            });

            // 4. Process Rows
            const labels=[], dS=[], dR=[], dDue=[], cS=[], cR=[], cDue=[], rows=[];
            let accS = 0, accR = 0, accDue = 0;

            if (opBal !== 0) {
                accS = opBal; // Sales cum starts with balance
                if (year === 'all' || true) kpi_ShareSales += opBal; // Add balance to share KPI
            }

            // We must add "Share Sales" from filtered data to KPI
            // Re-looping filtered sales to sum share for KPI correctly
            sFiltered.forEach(d => {
                if (timeMap[d.idx]) kpi_ShareSales += d.amount;
            });

            const keys = Object.keys(timeMap).map(Number).sort((a,b)=>a-b);
            keys.forEach(idx => {
                const item = timeMap[idx];
                
                accS += item.s; 
                accR += item.r; 
                accDue += item.due;

                labels.push(`${item.m} ${item.y}`);
                dS.push(item.s); dR.push(-item.r); dDue.push(item.due);
                cS.push(accS); cR.push(accR); cDue.push(accDue);

                rows.push({
                    ...item,
                    cumS: accS, cumR: accR, cumDue: accDue,
                    balance: accDue - accR,
                    isCurrent: idx === curIdx,
                    isFuture: idx > curIdx
                });
            });

            // 5. Update KPIs UI
            const lastRow = rows[rows.length-1] || {cumDue:0, cumR:0, balance:0};
            
            document.getElementById('kpiTotalSales').innerText = kpi_TotalSales.toLocaleString(undefined, {maximumFractionDigits:1});
            document.getElementById('kpiShareSales').innerText = accS.toLocaleString(undefined, {maximumFractionDigits:1}); // Use accumulated Share
            document.getElementById('kpiDue').innerText = accDue.toLocaleString(undefined, {maximumFractionDigits:1});
            document.getElementById('kpiPaid').innerText = accR.toLocaleString(undefined, {maximumFractionDigits:1});
            
            const bal = accDue - accR;
            const balEl = document.getElementById('kpiBalance');
            balEl.innerText = bal.toLocaleString(undefined, {maximumFractionDigits:1});
            balEl.className = `text-xl font-black font-num dir-ltr ${bal > 0 ? 'text-red-600' : 'text-emerald-600'}`; // Positive balance here means Debt (Bad)

            renderCharts(labels, dS, dR, dDue, cS, cR, cDue);
            renderTable(rows);
        }

        function renderCharts(labels, dS, dR, dDue, cS, cR, cDue) {
            // Monthly Stacked
            if (charts.monthly) charts.monthly.destroy();
            charts.monthly = new Chart(document.getElementById('chartMonthly'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'ÙØ±ÙˆØ´ (Ù…Ø«Ø¨Øª)', data: dS, backgroundColor: '#3b82f6', borderRadius: 4, order: 1 },
                        { label: 'Ù¾Ø±Ø¯Ø§Ø®Øª (Ù…Ù†ÙÛŒ)', data: dR, backgroundColor: '#ef4444', borderRadius: 4, order: 2 },
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { stacked: true, ticks:{font:FONT_OPTS} }, x: { stacked: true, grid:{display:false}, ticks:{font:FONT_OPTS} } }, plugins:{legend:{labels:{font:FONT_OPTS}}} }
            });

            // Cumulative
            if (charts.cum) charts.cum.destroy();
            charts.cum = new Chart(document.getElementById('chartCumulative'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'ÙØ±ÙˆØ´ ØªØ¬Ù…Ø¹ÛŒ', data: cS, borderColor: '#1d4ed8', backgroundColor: 'transparent', borderWidth: 2, tension: 0.2 },
                        { label: 'Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ¬Ù…Ø¹ÛŒ', data: cR, borderColor: '#16a34a', backgroundColor: 'transparent', borderWidth: 2, tension: 0.2 },
                        { label: 'ØªØ¹Ù‡Ø¯Ø§Øª Ø³Ø±Ø±Ø³ÛŒØ¯', data: cDue, borderColor: '#dc2626', borderDash:[5,5], borderWidth: 2, pointRadius:0 },
                        { label: 'ØªØ±Ø§Ø² (Ù…Ø§Ù†Ø¯Ù‡)', data: cDue.map((v,i)=>v-cR[i]), borderColor: '#64748b', backgroundColor: 'rgba(100,116,139,0.2)', fill: true, borderWidth:1, pointRadius:0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks:{font:FONT_OPTS} }, x: { grid:{display:false}, ticks:{font:FONT_OPTS} } }, plugins:{legend:{labels:{font:FONT_OPTS}}} }
            });
        }

        function renderTable(rows) {
            const tbody = document.getElementById('tableBody');
            const tfoot = document.getElementById('tableFooter');
            tbody.innerHTML = ''; tfoot.innerHTML = '';
            if(!rows.length) return;

            const fmt = (v) => v.toLocaleString(undefined, {maximumFractionDigits:1});
            const fmtNeg = (v) => v===0 ? "0" : `<span class="text-neg">(${fmt(v)})</span>`;

            rows.forEach(r => {
                const tr = document.createElement('tr');
                if(r.isCurrent) tr.style.backgroundColor = "#eff6ff";
                if(r.isFuture) tr.style.opacity = "0.6";
                
                tr.innerHTML = `
                    <td class="font-bold text-slate-800">${r.y}</td><td class="text-slate-600 font-bold">${r.m}</td>
                    <td class="dir-ltr text-blue-600 bg-sales">${fmt(r.s)}</td><td class="dir-ltr text-blue-800 font-black bg-sales border-l border-blue-200">${fmt(r.cumS)}</td>
                    <td class="dir-ltr text-pink-600 bg-due">${fmt(r.due)}</td><td class="dir-ltr text-pink-800 font-black bg-due border-l border-pink-200">${fmt(r.cumDue)}</td>
                    <td class="dir-ltr bg-paid">${fmtNeg(r.r)}</td><td class="dir-ltr font-black bg-paid border-l border-emerald-200">${fmtNeg(r.cumR)}</td>
                    <td class="dir-ltr font-black text-slate-800">${fmt(r.balance)}</td>
                `;
                tbody.appendChild(tr);
            });

            const l = rows[rows.length-1];
            tfoot.innerHTML = `<tr><td colspan="2">Ù†Ù‡Ø§ÛŒÛŒ</td>
                <td colspan="2" class="dir-ltr text-blue-900">${fmt(l.cumS)}</td>
                <td colspan="2" class="dir-ltr text-pink-900">${fmt(l.cumDue)}</td>
                <td colspan="2" class="dir-ltr text-red-700">(${fmt(l.cumR)})</td>
                <td class="dir-ltr text-slate-900 bg-slate-200">${fmt(l.balance)}</td></tr>`;
        }

        async function handleUpload(e, type) {
            if(!e.target.files[0]) return;
            const d = await parseFile(e.target.files[0], type);
            if(type==='sales') { rawSales=d; document.getElementById('lblSales').classList.replace('bg-blue-600','bg-slate-700'); }
            else { rawReceipts=d; document.getElementById('lblReceipts').classList.replace('bg-emerald-600','bg-slate-700'); }
            
            const sel = document.getElementById('clientSelect');
            sel.innerHTML = '<option value="all">Ù‡Ù…Ù‡ Ú©Ø§Ø±ÙØ±Ù…Ø§ÛŒØ§Ù† (ØªØ¬Ù…Ø¹ÛŒ)</option>';
            Array.from(uniqueClients).sort().forEach(c => sel.add(new Option(c,c)));
            
            if(rawSales.length && rawReceipts.length) runAnalysis();
        }

        initTimeSelector();
        ['fileSales','fileReceipts'].forEach(id=>document.getElementById(id).addEventListener('change',e=>handleUpload(e,id==='fileSales'?'sales':'receipts')));
        ['clientSelect','yearSelect','inpBalance','currentDateSelect'].forEach(id=>document.getElementById(id).addEventListener('change',runAnalysis));
    </script>
</body>
</html>
