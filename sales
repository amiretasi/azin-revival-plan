<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد جامع فروش - نسخه نهایی هوشمند</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --primary: #1e293b;
            --text-main: #334155;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-color); color: var(--text-main); }
        .card { background-color: var(--card-bg); border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 1.5rem; border: 1px solid #e2e8f0; }
        .section-title { font-size: 1.25rem; font-weight: 800; color: var(--primary); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0; display: flex; align-items: center; gap: 0.5rem; }
        
        /* Table Styles */
        th { position: sticky; top: 0; background-color: var(--primary); color: white; z-index: 10; padding: 1rem; cursor: pointer; user-select: none; }
        th:hover { background-color: #334155; }
        td { padding: 1rem; border-bottom: 1px solid #f1f5f9; }
        
        /* Sticky Footer for Summary */
        tfoot { position: sticky; bottom: 0; background-color: #1e293b; color: white; font-weight: bold; z-index: 10; box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.1); }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-10">
        
        <!-- Header -->
        <div class="card border-r-4 border-slate-800 flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">داشبورد جامع تحلیل فروش</h1>
                <p class="text-slate-500 mt-2 font-bold text-sm flex items-center gap-3">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-gray-400 rounded-sm"></span> میله‌ای ۱۴۰۳ (خاکستری)</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 bg-blue-500 rounded-full"></span> خطی ۱۴۰۳ (آبی)</span>
                </p>
            </div>
            
            <div class="flex flex-col items-end gap-3 w-full md:w-auto">
                <div class="relative group w-full md:w-auto">
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden" />
                    <label for="csvFileInput" class="cursor-pointer bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 transition-all w-full md:w-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span>بارگذاری CSV</span>
                    </label>
                </div>
                
                <!-- Filters -->
                <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                    <div class="w-full md:w-48">
                        <select id="yearSelect" class="w-full bg-slate-100 border-2 border-slate-200 rounded-xl p-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                            <option value="all">همه سال‌ها</option>
                            <option value="1403">سال ۱۴۰۳</option>
                            <option value="1404">سال ۱۴۰۴</option>
                        </select>
                    </div>
                    <div class="w-full md:w-72">
                        <select id="employerSelect" class="w-full bg-slate-100 border-2 border-slate-200 rounded-xl p-3 font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                            <option value="all">همه مشتریان (کل پورتفو)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="card border-t-4 border-gray-400">
                <p class="text-xs font-bold text-gray-500 mb-1">فروش کل ۱۴۰۳</p>
                <p class="text-2xl font-black text-gray-700 dir-ltr" id="kpi1403">0</p>
                <p class="text-xs text-gray-400 mt-1">میلیارد ریال</p>
            </div>
            <div class="card border-t-4 border-red-500">
                <p class="text-xs font-bold text-red-500 mb-1">فروش ۱۴۰۴ (تاکنون)</p>
                <p class="text-2xl font-black text-red-700 dir-ltr" id="kpi1404">0</p>
                <p class="text-xs text-red-400 mt-1">میلیارد ریال</p>
            </div>
            <div class="card border-t-4 border-emerald-500">
                <p class="text-xs font-bold text-emerald-600 mb-1">تعداد کل ست‌ها</p>
                <p class="text-2xl font-black text-emerald-800 dir-ltr" id="kpiCount">0</p>
                <p class="text-xs text-emerald-500 mt-1">ست / قطعه</p>
            </div>
            <div class="card border-t-4 border-amber-500">
                <p class="text-xs font-bold text-amber-600 mb-1">مجموع سهم شرکت</p>
                <p class="text-2xl font-black text-amber-800 dir-ltr" id="kpiShare">0</p>
                <p class="text-xs text-amber-500 mt-1">میلیارد ریال</p>
            </div>
        </div>

        <!-- SECTION 1: Total Amount -->
        <div>
            <h2 class="section-title"><span class="w-2 h-8 bg-slate-800 rounded mr-2"></span>۱. تحلیل جامع مبلغ کل فروش (میلیارد ریال)</h2>
            <div class="card h-[500px]">
                <canvas id="chartAmountCombo"></canvas>
            </div>
        </div>

        <!-- SECTION 2: Count -->
        <div>
            <h2 class="section-title"><span class="w-2 h-8 bg-emerald-600 rounded mr-2"></span>۲. تحلیل جامع تعداد فروش (ست)</h2>
            <div class="card h-[500px]">
                <canvas id="chartCountCombo"></canvas>
            </div>
        </div>

        <!-- SECTION 3: Share Amount -->
        <div>
            <h2 class="section-title"><span class="w-2 h-8 bg-amber-500 rounded mr-2"></span>۳. تحلیل جامع مبلغ سهم (میلیارد ریال)</h2>
            <div class="card h-[500px]">
                <canvas id="chartShareCombo"></canvas>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-slate-800 text-lg">ریز داده‌های فروش (هوشمند)</h3>
                <span class="text-xs bg-slate-100 text-slate-500 px-3 py-1 rounded-full">واحد: میلیارد ریال</span>
            </div>
            <div class="overflow-x-auto h-[500px] border rounded-xl relative">
                <table class="w-full text-right text-sm border-collapse">
                    <thead class="bg-slate-800 text-white font-medium sticky top-0 z-10">
                        <tr>
                            <th class="w-24" onclick="sortTable('year')">سال ↕</th>
                            <th onclick="sortTable('month')">ماه ↕</th>
                            <th onclick="sortTable('source')">مشتری ↕</th>
                            <th onclick="sortTable('count')">تعداد (ست) ↕</th>
                            <th onclick="sortTable('amount')">مبلغ کل ↕</th>
                            <th onclick="sortTable('share')">مبلغ سهم ↕</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
                    <tfoot class="sticky bottom-0 bg-slate-900 text-white font-bold z-10">
                        <tr>
                            <td colspan="3" class="p-4 text-center">جمع کل (فیلتر شده)</td>
                            <td class="p-4 dir-ltr text-amber-400 font-mono text-lg" id="sumCount">0</td>
                            <td class="p-4 dir-ltr text-blue-400 font-mono text-lg" id="sumAmount">0</td>
                            <td class="p-4 dir-ltr text-emerald-400 font-mono text-lg" id="sumShare">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        Chart.defaults.font.family = 'Vazirmatn';
        Chart.defaults.color = '#64748b';
        
        const STYLES = {
            bar1403: '#cbd5e1',       // Gray Bar
            bar1404: '#f87171',       // Red Bar
            line1403: '#3b82f6',      // Blue Dashed Line
            line1404: '#b91c1c'       // Red Solid Line
        };

        let globalData = [];
        let currentFilteredData = [];
        let chartInstances = {};

        // Default Data
        const initialCSVData = `ردیف,سال,ماه,کارفرما,تعداد (ست),"مبلغ کل (میلیون ریال)","مبلغ سهم (میلیون ریال)"
1,1403,فروردین,سازه گستر,"11,987","773,264","497,242"
2,1403,اردیبهشت,سازه گستر,"54,328","1,978,107","2,305,251"
3,1403,خرداد,سازه گستر,"19,086","1,964,943","1,173,562"
4,1403,تیر,سازه گستر,"55,486","2,080,691","3,795,484"
5,1403,مرداد,سازه گستر,"29,706","2,914,838","2,919,433"
6,1403,شهریور,سازه گستر,"21,092","2,204,774","1,514,327"
7,1403,مهر,سازه گستر,"30,243","2,275,438","2,145,850"
8,1403,ابان,سازه گستر,"23,572","1,612,479","1,546,245"
9,1403,اذر,سازه گستر,"23,260","1,647,306","1,522,745"
10,1403,دی,سازه گستر,"21,769","1,609,168","1,509,141"
11,1403,بهمن,سازه گستر,"22,656","1,770,446","1,690,920"
12,1403,اسفند,سازه گستر,"21,166","6,508,320","1,547,419"
13,1403,فروردین,زامیاد,0,0,0
14,1403,اردیبهشت,زامیاد,50,"2,508","2,508"
15,1403,خرداد,زامیاد,0,0,0
16,1403,تیر,زامیاد,0,0,0
17,1403,مرداد,زامیاد,0,0,0
18,1403,شهریور,زامیاد,0,0,0
19,1403,مهر,زامیاد,0,0,0
20,1403,ابان,زامیاد,10,"1,522","1,522"
21,1403,اذر,زامیاد,50,"2,500","2,500"
22,1403,دی,زامیاد,50,"2,503","2,503"
23,1403,بهمن,زامیاد,60,"3,084","3,084"
24,1403,اسفند,زامیاد,98,"9,690","9,690"
25,1403,فروردین,آرمان موتور,0,0,0
26,1403,اردیبهشت,آرمان موتور,0,0,0
27,1403,خرداد,آرمان موتور,0,81,81
28,1403,تیر,آرمان موتور,0,0,0
29,1403,مرداد,آرمان موتور,0,0,0
30,1403,شهریور,آرمان موتور,0,"1,846","1,846"
31,1403,مهر,آرمان موتور,0,433,433
32,1403,ابان,آرمان موتور,0,"4,358","4,358"
33,1403,اذر,آرمان موتور,0,"4,226","4,226"
34,1403,دی,آرمان موتور,0,0,0
35,1403,بهمن,آرمان موتور,0,"16,039","16,039"
36,1403,اسفند,آرمان موتور,0,"32,078","32,078"
37,1403,فروردین,قالب ها,"1,360","8,918",775
38,1403,اردیبهشت,قالب ها,"4,640","29,238","2,645"
39,1403,خرداد,قالب ها,"4,800","29,909","2,736"
40,1403,تیر,قالب ها,"5,040","31,405","2,873"
41,1403,مرداد,قالب ها,"3,760","23,429","2,143"
42,1403,شهریور,قالب ها,"3,440","21,435","1,961"
43,1403,مهر,قالب ها,"4,000","24,924","2,280"
44,1403,ابان,قالب ها,"3,840","23,927","2,189"
45,1403,اذر,قالب ها,"2,640","16,558","1,505"
46,1403,دی,قالب ها,"3,440","21,435","1,961"
47,1403,بهمن,قالب ها,"1,572","103,780",896
48,1403,اسفند,قالب ها,0,0,0
49,1403,فروردین,سودیکو - ضایعات,0,466,466
50,1403,اردیبهشت,سودیکو - ضایعات,0,"16,604","16,604"
51,1403,خرداد,سودیکو - ضایعات,0,"7,907","7,907"
52,1403,تیر,سودیکو - ضایعات,0,"11,937","11,937"
53,1403,مرداد,سودیکو - ضایعات,0,"29,180","29,180"
54,1403,شهریور,سودیکو - ضایعات,0,"7,690","7,690"
55,1403,مهر,سودیکو - ضایعات,0,"8,378","8,378"
56,1403,ابان,سودیکو - ضایعات,,"9,611","9,611"
57,1403,اذر,سودیکو - ضایعات,,"10,635","10,635"
58,1403,دی,سودیکو - ضایعات,,"7,371","7,371"
59,1403,بهمن,سودیکو - ضایعات,,"29,716","29,716"
60,1403,اسفند,سودیکو - ضایعات,,"11,873","11,873"
61,1403,فروردین,سودیکو - ورق,0,0,0
62,1403,اردیبهشت,سودیکو - ورق,0,0,0
63,1403,خرداد,سودیکو - ورق,0,0,0
64,1403,تیر,سودیکو - ورق,0,0,0
65,1403,مرداد,سودیکو - ورق,0,0,0
66,1403,شهریور,سودیکو - ورق,0,0,0
67,1403,مهر,سودیکو - ورق,0,0,0
68,1403,ابان,سودیکو - ورق,,"1,211","1,211"
69,1403,اذر,سودیکو - ورق,,0,0
70,1403,دی,سودیکو - ورق,,420,420
71,1403,بهمن,سودیکو - ورق,,"272,318","272,318"
72,1403,اسفند,سودیکو - ورق,,"459,823","459,823"
73,1403,فروردین,خدمات آزمون,0,0,0
74,1403,اردیبهشت,خدمات آزمون,0,25,25
75,1403,خرداد,خدمات آزمون,0,961,961
76,1403,تیر,خدمات آزمون,0,"5,071","5,071"
77,1403,مرداد,خدمات آزمون,0,836,836
78,1403,شهریور,خدمات آزمون,0,913,913
79,1403,مهر,خدمات آزمون,0,"1,116","1,116"
80,1403,ابان,خدمات آزمون,0,"1,478","1,478"
81,1403,اذر,خدمات آزمون,0,"4,074","4,074"
82,1403,دی,خدمات آزمون,0,"3,732","3,732"
83,1403,بهمن,خدمات آزمون,0,"6,113","6,113"
84,1403,اسفند,خدمات آزمون,0,"3,193","3,193"
85,1403,فروردین,سایپا یدک,0,"2,996","2,996"
86,1403,اردیبهشت,سایپا یدک,0,"11,603","11,603"
87,1403,خرداد,سایپا یدک,0,"7,946","7,946"
88,1403,تیر,سایپا یدک,0,"15,054","15,054"
89,1403,مرداد,سایپا یدک,0,"9,041","9,041"
90,1403,شهریور,سایپا یدک,0,"4,039","4,039"
91,1403,مهر,سایپا یدک,0,"1,327","1,327"
92,1403,ابان,سایپا یدک,0,585,585
93,1403,اذر,سایپا یدک,0,557,557
94,1403,دی,سایپا یدک,0,"2,820","2,820"
95,1403,بهمن,سایپا یدک,0,"3,295","3,295"
96,1403,اسفند,سایپا یدک,0,0,0
97,1404,فروردین,سازه گستر,"9,088","1,106,399","894,528"
98,1404,اردیبهشت,سازه گستر,"20,254","2,132,032","1,652,812"
99,1404,خرداد,سازه گستر,"11,304","1,111,776","848,504"
100,1404,تیر,سازه گستر,"9,194","948,572","734,730"
101,1404,مرداد,سازه گستر,"7,364","806,296","633,000"
102,1404,شهریور,سازه گستر,"18,388","1,720,182","1,308,908"
103,1404,مهر,سازه گستر,"7,792","783,664","612,208"
104,1404,آبان ,سازه گستر,"7,576","753,425","585,252"
105,1404,اذر,سازه گستر,0,0,0
106,1404,دی,سازه گستر,0,0,0
107,1404,بهمن,سازه گستر,0,0,0
108,1404,اسفند,سازه گستر,0,0,0
109,1404,فروردین,زامیاد,100,"7,000","7,000"
110,1404,اردیبهشت,زامیاد,370,"25,900","25,900"
111,1404,خرداد,زامیاد,405,"28,350","28,350"
112,1404,تیر,زامیاد,360,"25,200","25,200"
113,1404,مرداد,زامیاد,930,"65,100","65,100"
114,1404,شهریور,زامیاد,"4,830","338,100","338,100"
115,1404,مهر,زامیاد,"3,585","250,950","250,950"
116,1404,آبان ,زامیاد,"2,990","209,300","209,300"
117,1404,اذر,زامیاد,,,
118,1404,دی,زامیاد,,,
119,1404,بهمن,زامیاد,,,
120,1404,اسفند,زامیاد,,,
121,1404,فروردین,آرمان موتور,0,"22,652","22,652"
122,1404,اردیبهشت,آرمان موتور,0,"65,125","65,125"
123,1404,خرداد,آرمان موتور,0,"48,136","48,136"
124,1404,تیر,آرمان موتور,0,"67,956","67,956"
125,1404,مرداد,آرمان موتور,0,"22,652","22,652"
126,1404,شهریور,آرمان موتور,0,0,0
127,1404,مهر,آرمان موتور,0,"11,326","11,326"
128,1404,آبان ,آرمان موتور,0,"11,326","11,326"
129,1404,اذر,آرمان موتور,,,
130,1404,دی,آرمان موتور,,,
131,1404,بهمن,آرمان موتور,,,
132,1404,اسفند,آرمان موتور,,,
133,1404,فروردین,قالب ها,0,"6,480",598
134,1404,اردیبهشت,قالب ها,0,"23,760","2,191"
135,1404,خرداد,قالب ها,0,"20,160","1,859"
136,1404,تیر,قالب ها,0,"10,800",996
137,1404,مرداد,قالب ها,0,"7,200",664
138,1404,شهریور,قالب ها,0,"24,480","2,258"
139,1404,مهر,قالب ها,0,"25,200","2,324"
140,1404,آبان ,قالب ها,0,"35,883","3,309"
141,1404,اذر,قالب ها,,,
142,1404,دی,قالب ها,,,
143,1404,بهمن,قالب ها,,,
144,1404,اسفند,قالب ها,,,
145,1404,فروردین,سودیکو,0,"2,899","2,899"
146,1404,اردیبهشت,سودیکو,0,"14,828","14,828"
147,1404,خرداد,سودیکو,0,"4,898","4,898"
148,1404,تیر,سودیکو,0,"5,846","5,846"
149,1404,مرداد,سودیکو,0,"2,311","2,311"
150,1404,شهریور,سودیکو,0,"6,694","6,694"
151,1404,مهر,سودیکو,0,"2,806","2,806"
152,1404,آبان ,سودیکو,0,"4,058","4,058"
153,1404,اذر,سودیکو,,,
154,1404,دی,سودیکو,,,
155,1404,بهمن,سودیکو,,,
156,1404,اسفند,سودیکو,,,
157,1404,فروردین,سودیکو,0,0,0
158,1404,اردیبهشت,سودیکو,0,0,0
159,1404,خرداد,سودیکو,0,"22,171","22,171"
160,1404,تیر,سودیکو,0,0,0
161,1404,مرداد,سودیکو,0,0,0
162,1404,شهریور,سودیکو,0,0,0
163,1404,مهر,سودیکو,0,0,0
164,1404,آبان ,سودیکو,0,"66,193","66,193"
165,1404,اذر,سودیکو,,,
166,1404,دی,سودیکو,,,
167,1404,بهمن,سودیکو,,,
168,1404,اسفند,سودیکو,,,
169,1404,فروردین,خدمات آزمون,0,"874.4","874.4"
170,1404,اردیبهشت,خدمات آزمون,0,"9284.6","9284.6"
171,1404,خرداد,خدمات آزمون,0,"6200.09","6200.09"
172,1404,تیر,خدمات آزمون,0,"10280.4","10280.4"
173,1404,مرداد,خدمات آزمون,0,"9302.033","9302.033"
174,1404,شهریور,خدمات آزمون,0,"2689.596","2689.596"
175,1404,مهر,خدمات آزمون,0,"9395.1","9395.1"
176,1404,آبان ,خدمات آزمون,0,"4004.065","4004.065"
177,1404,اذر,خدمات آزمون,0,0,0
178,1404,دی,خدمات آزمون,0,0,0
179,1404,بهمن,خدمات آزمون,0,0,0
180,1404,اسفند,خدمات آزمون,0,0,0
181,1404,فروردین,سایپا یدک,0,0,0
182,1404,اردیبهشت,سایپا یدک,0,"12835.2","12835.2"
183,1404,خرداد,سایپا یدک,0,0,0
184,1404,تیر,سایپا یدک,0,0,0
185,1404,مرداد,سایپا یدک,0,4884,4884
186,1404,شهریور,سایپا یدک,0,0,0
187,1404,مهر,سایپا یدک,0,"4861.8","4861.8"
188,1404,آبان ,سایپا یدک,0,19918,19918
189,1404,اذر,سایپا یدک,0,0,0
190,1404,دی,سایپا یدک,0,0,0
191,1404,بهمن,سایپا یدک,0,0,0
192,1404,اسفند,سایپا یدک,0,0,0`;

        const monthsOrder = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];

        // --- 1. DATA PARSING (Regex Fix) ---
        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');
            let start = lines[0].includes('کارفرما') ? 1 : 0;

            for(let i=start; i<lines.length; i++){
                let line = lines[i].trim();
                if(!line) continue;
                
                // Fix: Properly handle CSV with commas inside quotes AND spacing
                // match /(".*?"|[^,]+)(?=\s*,|\s*$)/g is safer
                const parts = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g);
                if(!parts || parts.length < 6) continue;

                let id = parts[0].trim();
                let year = parseInt(parts[1].trim());
                let month = parts[2].trim().replace('ابان', 'آبان');
                let source = parts[3].trim();
                
                // Remove quotes/commas -> Divide by 1000 for Billion
                let count = parseFloat((parts[4] || "0").replace(/["',]/g, '')) || 0;
                let amountBillion = (parseFloat((parts[5] || "0").replace(/["',]/g, '')) || 0) / 1000;
                let shareBillion = (parseFloat((parts[6] || "0").replace(/["',]/g, '')) || 0) / 1000;

                rows.push({
                    id, year, month, source, count,
                    amount: amountBillion,
                    share: shareBillion
                });
            }
            return rows;
        }

        // --- 2. INIT & LOGIC ---
        function init(csv) {
            globalData = parseCSV(csv);
            
            // Fill Customer Dropdown
            const employers = [...new Set(globalData.map(d => d.source))].sort();
            const select = document.getElementById('employerSelect');
            select.innerHTML = '<option value="all">همه مشتریان (کل پورتفو)</option>';
            employers.forEach(emp => {
                const opt = document.createElement('option');
                opt.value = emp; opt.textContent = emp; select.appendChild(opt);
            });

            // Event Listeners
            document.getElementById('employerSelect').addEventListener('change', applyFilters);
            document.getElementById('yearSelect').addEventListener('change', applyFilters);

            updateKPIs();
            applyFilters(); // Initial render
        }

        function applyFilters() {
            const empVal = document.getElementById('employerSelect').value;
            const yearVal = document.getElementById('yearSelect').value;

            // Update Charts (Only filter by Customer to keep year comparison)
            updateAllCharts(empVal);

            // Update Table (Filter by Customer AND Year)
            currentFilteredData = globalData.filter(d => {
                const empMatch = empVal === 'all' || d.source === empVal;
                const yearMatch = yearVal === 'all' || d.year.toString() === yearVal;
                return empMatch && yearMatch;
            });
            renderTable(currentFilteredData);
        }

        function updateKPIs() {
            const t1403 = globalData.filter(d => d.year === 1403).reduce((s,d) => s + d.amount, 0);
            const t1404 = globalData.filter(d => d.year === 1404).reduce((s,d) => s + d.amount, 0);
            const count = globalData.reduce((s,d) => s + d.count, 0);
            const share = globalData.reduce((s,d) => s + d.share, 0);
            
            document.getElementById('kpi1403').innerText = t1403.toLocaleString(undefined, {maximumFractionDigits: 1});
            document.getElementById('kpi1404').innerText = t1404.toLocaleString(undefined, {maximumFractionDigits: 1});
            document.getElementById('kpiCount').innerText = count.toLocaleString();
            document.getElementById('kpiShare').innerText = share.toLocaleString(undefined, {maximumFractionDigits: 1});
        }

        // --- 3. CHARTS ---
        function generateChartSet(client, metricKey, chartId) {
            let data = globalData;
            if(client !== 'all') data = globalData.filter(d => d.source === client);

            const m1403 = [], m1404 = [], c1403 = [], c1404 = [];
            let acc1403 = 0, acc1404 = 0;

            monthsOrder.forEach((m, idx) => {
                const v1403 = data.filter(d => d.year === 1403 && d.month.includes(m.substring(0,3))).reduce((s,d)=>s+d[metricKey],0);
                const v1404 = data.filter(d => d.year === 1404 && d.month.includes(m.substring(0,3))).reduce((s,d)=>s+d[metricKey],0);
                
                m1403.push(v1403);
                acc1403 += v1403;
                c1403.push(acc1403);

                if(idx > 7) { 
                    m1404.push(null); c1404.push(null);
                } else {
                    m1404.push(v1404); acc1404 += v1404; c1404.push(acc1404);
                }
            });

            const ctx = document.getElementById(chartId).getContext('2d');
            if(chartInstances[chartId]) chartInstances[chartId].destroy();
            
            chartInstances[chartId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthsOrder,
                    datasets: [
                        { type: 'bar', label: 'ماهانه ۱۴۰۳', data: m1403, backgroundColor: STYLES.bar1403, order: 3, yAxisID: 'yLeft' },
                        { type: 'bar', label: 'ماهانه ۱۴۰۴', data: m1404, backgroundColor: STYLES.bar1404, order: 4, yAxisID: 'yLeft' },
                        { type: 'line', label: 'تجمعی ۱۴۰۳', data: c1403, borderColor: STYLES.line1403, borderDash: [5, 5], borderWidth: 2, pointRadius: 3, fill: false, order: 2, yAxisID: 'yRight' },
                        { type: 'line', label: 'تجمعی ۱۴۰۴', data: c1404, borderColor: STYLES.line1404, borderWidth: 3, pointRadius: 4, fill: false, order: 1, yAxisID: 'yRight' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { position: 'top', labels: { font: { family: 'Vazirmatn' } } } },
                    scales: {
                        yLeft: { type: 'linear', display: true, position: 'left', grid: { display: false } },
                        yRight: { type: 'linear', display: true, position: 'right', grid: { borderDash: [2, 2] } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateAllCharts(client) {
            generateChartSet(client, 'amount', 'chartAmountCombo');
            generateChartSet(client, 'count', 'chartCountCombo');
            generateChartSet(client, 'share', 'chartShareCombo');
        }

        // --- TABLE RENDER ---
        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            let sCount = 0, sAmount = 0, sShare = 0;

            data.forEach(d => {
                sCount += d.count;
                sAmount += d.amount;
                sShare += d.share;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition';
                const yrClass = d.year === 1404 ? 'text-red-600 bg-red-50' : 'text-gray-500 bg-gray-50';
                
                tr.innerHTML = `
                    <td class="font-bold text-center"><span class="px-2 py-1 rounded ${yrClass}">${d.year}</span></td>
                    <td class="text-slate-700">${d.month}</td>
                    <td class="font-bold text-slate-800">${d.source}</td>
                    <td class="font-mono dir-ltr text-emerald-600">${d.count.toLocaleString()}</td>
                    <td class="font-mono dir-ltr font-bold text-blue-700">${d.amount.toLocaleString(undefined, {maximumFractionDigits: 3})}</td>
                    <td class="font-mono dir-ltr text-amber-600 text-sm">${d.share.toLocaleString(undefined, {maximumFractionDigits: 3})}</td>
                `;
                tbody.appendChild(tr);
            });

            // Update Summary Footer
            document.getElementById('sumCount').innerText = sCount.toLocaleString();
            document.getElementById('sumAmount').innerText = sAmount.toLocaleString(undefined, {maximumFractionDigits: 3});
            document.getElementById('sumShare').innerText = sShare.toLocaleString(undefined, {maximumFractionDigits: 3});
        }

        // Sorting Logic
        let sortDir = 1;
        window.sortTable = function(key) {
            sortDir *= -1;
            currentFilteredData.sort((a,b) => {
                let vA = a[key], vB = b[key];
                if(typeof vA === 'string') return sortDir * vA.localeCompare(vB);
                return sortDir * (vA - vB);
            });
            renderTable(currentFilteredData);
        }

        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                init(e.target.result);
                alert('فایل جدید بارگذاری شد.');
            };
            reader.readAsText(file);
        });

        init(initialCSVData);
    </script>
</body>
</html>
